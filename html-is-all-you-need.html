<!DOCTYPE html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="main.css" rel="stylesheet">
</head>
<script type="module">
  import * as htl from 'https://esm.run/htl'
  import * as Plot from 'https://esm.run/@observablehq/plot'
  import { Runtime, Inspector } from "https://cdn.jsdelivr.net/npm/@observablehq/runtime@5/dist/runtime.js";

  const runtime = new Runtime();
  const module = runtime.module();
  window.runtime = runtime;
  window.module = module;
  window.htl = htl
  window.Plot = Plot

  function freakyObserver(elementId) {
    const inspector = document.createElement("div");
    const oldElement = document.getElementById(elementId)
    const parentElement = oldElement.parentNode;
    parentElement.insertBefore(inspector, oldElement);
    return new Inspector(inspector);
  }

  window.freakyObserver = freakyObserver
</script>
<script>

  
  /**
   * More accurately described as "viewBefore", 
   * this function takes an elementId, finds it, and inserts the new element
   * before it.
   */
  function view(elementId, newElement) {
    const oldElement = document.getElementById(elementId)
    const parentElement = oldElement.parentNode;
    parentElement.insertBefore(newElement, oldElement);
  }

  /**
   * This function takes an elementId, finds it, and inserts the new element
   * before it _if_ an element with the same tag is not already present.
   * 
   * If an element with the same tag is present,
   * it removes the existing element with the same tag,
   * and then adds the new element. 
   */
  function sview(elementId, newElement, tag) {
    const oldElement = document.getElementById(elementId)
    const parentElement = oldElement.parentNode;
    const existingElement = parentElement.querySelector(tag)
    if (existingElement) {
      existingElement.remove()
    }
    parentElement.insertBefore(newElement, oldElement);
  }

  function delay(duration, value) {
    return new Promise(function(resolve) {
      setTimeout(function() {
        resolve(value);
      }, duration);
    });
  }

  function observe(id) {
    const tag = 'observe-' + id
    return (
      {
        pending() {
          console.log(`${id}: pending`);
          sview(id,
            htl.html`<p>${id}: pending</p>`,
            tag
          )
        },
        fulfilled(value) {
          console.log(`${id}: fullfilled`, value);
          sview(id,
            htl.html`<p>${id}: fullfilled ${value}</p>`,
            tag
          )
        },
        rejected(error) {
          console.error(`${id}: rejected`, error);
          sview(id,
            htl.html`<p>${id}: rejected ${error}</p>`,
            tag)
        }
      }
    )
  }
</script>
<style>
  .echo {
    display: block;
    white-space: pre;
    font-family: monospace;
    background-color: #f0f0f0;
  }
</style>
<html>

<head>
  <meta charset="UTF-8">
  <title>Title of your webpage</title>
</head>

<body>
  <main>

    <h1>Single file JS notebooks</h1>

    <script type="module" class="echo" id="cell1">
      const cell1 = module.variable(freakyObserver("cell1")).define("cell1", async function* () {
        for (const i of [1, 2, 3]) {
          yield await delay(1000, htl.html`<h1>${i}</h1>`)
        }
      });
    </script>

    <script type="module" class="echo" id="example1">
      const id = 'example1'
      const example1 = htl.html`<p>alpha</p>`
      view(id, example1)
      const example2 = htl.html`<p>beta</p>`
      view(id, example2)
    </script>

    <script type="module" class="echo" id="example2">
      const id = 'example2'
      const numbers = [
        170.16, 172.53, 172.54, 173.44, 174.35, 174.55, 173.16, 174.59, 176.18, 177.90,
        176.15, 179.37, 178.61, 177.30, 177.30, 177.25, 174.51, 172.00, 170.16, 165.53,
        166.87, 167.17, 166.00, 159.10, 154.83, 163.09, 160.29, 157.07, 158.50, 161.95,
        163.04, 169.79, 172.36, 172.05, 172.83, 171.80, 173.67, 176.35, 179.10, 179.26
      ]
      view(id, Plot.lineY(numbers).plot())
    </script>

  </main>
</body>

</html>