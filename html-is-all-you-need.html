<!DOCTYPE html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="main.css" rel="stylesheet">
</head>
<html>

<head>
  <meta charset="UTF-8">
  <title>HTML is all you need</title>
</head>

<body>
  <main>
    <header>
      <nav>
        <h2>
          <marquee>
            <a href="/">‚Üê Max Bo</a>
          </marquee>
        </h2>
      </nav>
      <h2>Can we build a reactive document in a single HTML file?</h2>
    </header>

    <p>Yes (standing on the shoulders of <a href="https://observablehq.com/">Observable</a>).</p>

    <br />

    <p>First, we'll steal a trick from <a href="https://secretgeek.github.io/html_wysiwyg/html.html">This page is a
        truly naked, brutalist html quine</a>,
      and we'll create a <code>echo</code> class that will let us display
      <code>style</code> and <code>script</code> tags inline.</p>
      <p>This doesn't perfectly quine/echo all the source HTML to the DOM, so <kbd>View source</kbd> to see the "real" HTML - note the <code>id</code>s of the <code>script</code> blocks.</p>

      <style class="echo">
        .echo {
          display: block;
          white-space: pre;
          font-family: monospace;
          background-color: #EEE;
          margin: .2rem;
        }
      </style>

    <p>Then we'll import the <a href="https://github.com/observablehq/runtime">Observable runtime</a>,
      <a href="https://github.com/observablehq/htl">Hypertext Literal</a>, and <a
        href="https://github.com/observablehq/plot">Observable Plot</a> libraries, and bind them to the global window
      context.
    </p>

    
    <script type="module" class="echo">
      import * as htl from 'https://esm.run/htl'
      import * as Plot from 'https://esm.run/@observablehq/plot'
      import { Runtime, Inspector } from "https://esm.run/@observablehq/runtime";
      const runtime = new Runtime();
      const module = runtime.module();

      function cell(name, inputsOrDefinition, maybeDefinition) {
        if (maybeDefinition) {
          const inputs = inputsOrDefinition
          const definition = maybeDefinition
          const variable = module.variable(observer(name)).define(name, inputs, definition)
        } else {
          const definition = inputsOrDefinition
          const variable = module.variable(observer(name)).define(name, definition)
        }
      }

      function observer(cellName) {
        const div = document.createElement("div");
        const cellElement = document.getElementById(cellName)
        cellElement.parentNode.insertBefore(div, cellElement);
        return new Inspector(div);
      }

      window.htl = htl
      window.Plot = Plot
      window.cell = cell
      window.observer = observer
    </script>

    And we'll declare a quick helper function to demo reactivity.

    <script class="echo">
      function delay(duration, value) {
        return new Promise(function (resolve) {
          setTimeout(function () {
            resolve(value);
          }, duration);
        });
      }
    </script>

    Now we declare some cell called <code>cell1</code> that will emit a number every second.

    <script type="module" class="echo" id="cell1">
      cell("cell1", async function* () {
        let i = 0
        while (true) {
          yield await delay(1000, i++)
        }
      });
    </script>

    and we can declare some cells that depend on it.

    <script type="module" class="echo" id="cell2">
      cell("cell2", ["cell1"], (cell1) => {
        return htl.html`<b>${cell1 * 10}</b>`
      });
    </script>

    <script type="module" class="echo" id="cell3">
      cell("cell3", ["cell1"], (cell1) => {
        const numbers = [
          170.16, 172.53, 172.54, 173.44, 174.35, 174.55, 173.16, 174.59, 176.18, 177.90,
          176.15, 179.37, 178.61, 177.30, 177.30, 177.25, 174.51, 172.00, 170.16, 165.53,
          166.87, 167.17, 166.00, 159.10, 154.83, 163.09, 160.29, 157.07, 158.50, 161.95,
          163.04, 169.79, 172.36, 172.05, 172.83, 171.80, 173.67, 176.35, 179.10, 179.26
        ]
        return Plot.plot({
          marks: [
            Plot.lineY(numbers, { x: (d, i) => i, y: d => d }),
            Plot.ruleX([cell1])
          ]
        })
      });
    </script>


  </main>
</body>

</html>