/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/@uwdata/mosaic-plot@0.7.0/src/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{synchronizer as t,distinct as e,isArrowTable as n,convertArrowValue as i,MosaicClient as s,convertArrowColumn as r,convertArrowArrayType as o,isParam as a,coordinator as l,throttle as c,isSelection as h,Selection as u}from"../mosaic-core@0.7.0/_esm.js";import*as p from"../../@observablehq/plot@0.6.13/_esm.js";import{scale as d}from"../../@observablehq/plot@0.6.13/_esm.js";import{Query as f,column as y,isParamLike as g,Ref as m,scaleTransform as x,sql as b,min as E,argmin as v,max as A,argmax as R,isBetween as w,lte as O,lt as L,sum as k,count as S,neq as M,and as T,isNull as F,gt as N,geojson as $,isNotNull as I,regrIntercept as D,regrSlope as z,regrCount as G,regrSYY as C,regrSXX as q,regrAvgX as B,castDouble as P,eq as j,literal as _,isNotDistinct as W,or as U}from"../mosaic-sql@0.7.0/_esm.js";import{color as H,scaleLinear as Y,InternSet as V,ascending as X,Delaunay as Z,randomLcg as Q,contours as J,rgb as K,range as tt,brush as et,brushX as nt,brushY as it,min as st,max as rt,select as ot,pointer as at,zoom as lt,ZoomTransform as ct}from"../../d3@7.8.5/_esm.js";const ht=Symbol("Fixed"),ut=Symbol("Transient"),pt=Symbol("Transform"),dt=new Map([["style","style"],["width","width"],["height","height"],["margin","margin"],["marginLeft","marginLeft"],["marginRight","marginRight"],["marginTop","marginTop"],["marginBottom","marginBottom"],["align","align"],["aspectRatio","aspectRatio"],["axis","axis"],["inset","inset"],["grid","grid"],["label","label"],["padding","padding"],["round","round"],["xScale","x.type"],["xDomain","x.domain"],["xRange","x.range"],["xNice","x.nice"],["xInset","x.inset"],["xInsetLeft","x.insetLeft"],["xInsetRight","x.insetRight"],["xClamp","x.clamp"],["xRound","x.round"],["xAlign","x.align"],["xPadding","x.padding"],["xPaddingInner","x.paddingInner"],["xPaddingOuter","x.paddingOuter"],["xAxis","x.axis"],["xTicks","x.ticks"],["xTickSize","x.tickSize"],["xTickSpacing","x.tickSpacing"],["xTickPadding","x.tickPadding"],["xTickFormat","x.tickFormat"],["xTickRotate","x.tickRotate"],["xGrid","x.grid"],["xLine","x.line"],["xLabel","x.label"],["xLabelAnchor","x.labelAnchor"],["xLabelOffset","x.labelOffset"],["xFontVariant","x.fontVariant"],["xAriaLabel","x.ariaLabel"],["xAriaDescription","x.ariaDescription"],["xReverse","x.reverse"],["xZero","x.zero"],["xBase","x.base"],["xExponent","x.exponent"],["xConstant","x.constant"],["yScale","y.type"],["yDomain","y.domain"],["yRange","y.range"],["yNice","y.nice"],["yInset","y.inset"],["yInsetTop","y.insetTop"],["yInsetBottom","y.insetBottom"],["yClamp","y.clamp"],["yRound","y.round"],["yAlign","y.align"],["yPadding","y.padding"],["yPaddingInner","y.paddingInner"],["yPaddingOuter","y.paddingOuter"],["yAxis","y.axis"],["yTicks","y.ticks"],["yTickSize","y.tickSize"],["yTickSpacing","y.tickSpacing"],["yTickPadding","y.tickPadding"],["yTickFormat","y.tickFormat"],["yTickRotate","y.tickRotate"],["yGrid","y.grid"],["yLine","y.line"],["yLabel","y.label"],["yLabelAnchor","y.labelAnchor"],["yLabelOffset","y.labelOffset"],["yFontVariant","y.fontVariant"],["yAriaLabel","y.ariaLabel"],["yAriaDescription","y.ariaDescription"],["yReverse","y.reverse"],["yZero","y.zero"],["yBase","y.base"],["yExponent","y.exponent"],["yConstant","y.constant"],["facetMargin","facet.margin"],["facetMarginTop","facet.marginTop"],["facetMarginBottom","facet.marginBottom"],["facetMarginLeft","facet.marginLeft"],["facetMarginRight","facet.marginRight"],["facetGrid","facet.grid"],["facetLabel","facet.label"],["fxDomain","fx.domain"],["fxRange","fx.range"],["fxNice","fx.nice"],["fxInset","fx.inset"],["fxInsetLeft","fx.insetLeft"],["fxInsetRight","fx.insetRight"],["fxRound","fx.round"],["fxAlign","fx.align"],["fxPadding","fx.padding"],["fxPaddingInner","fx.paddingInner"],["fxPaddingOuter","fx.paddingOuter"],["fxAxis","fx.axis"],["fxTicks","fx.ticks"],["fxTickSize","fx.tickSize"],["fxTickSpacing","fx.tickSpacing"],["fxTickPadding","fx.tickPadding"],["fxTickFormat","fx.tickFormat"],["fxTickRotate","fx.tickRotate"],["fxGrid","fx.grid"],["fxLine","fx.line"],["fxLabel","fx.label"],["fxLabelAnchor","fx.labelAnchor"],["fxLabelOffset","fx.labelOffset"],["fxFontVariant","fx.fontVariant"],["fxAriaLabel","fx.ariaLabel"],["fxAriaDescription","fx.ariaDescription"],["fxReverse","fx.reverse"],["fyDomain","fy.domain"],["fyRange","fy.range"],["fyNice","fy.mice"],["fyInset","fy,inset"],["fyInsetTop","fy.insetTop"],["fyInsetBottom","fy.insetBottom"],["fyRound","fy.round"],["fyAlign","fy.align"],["fyPadding","fy.padding"],["fyPaddingInner","fy.paddingInner"],["fyPaddingOuter","fy.paddingOuter"],["fyAxis","fy.axis"],["fyTicks","fy.ticks"],["fyTickSize","fy.tickSize"],["fyTickSpacing","fy.tickSpacing"],["fyTickPadding","fy.tickPadding"],["fyTickFormat","fy.tickFormat"],["fyTickRotate","fy.tickRotate"],["fyGrid","fy.grid"],["fyLine","fy.line"],["fyLabel","fy.label"],["fyLabelAnchor","fy.labelAnchor"],["fyLabelOffset","fy.labelOffset"],["fyFontVariant","fy.fontVariant"],["fyAriaLabel","fy.ariaLabel"],["fyAriaDescription","fy.ariaDescription"],["fyReverse","fy.reverse"],["colorScale","color.type"],["colorDomain","color.domain"],["colorRange","color.range"],["colorClamp","color.clamp"],["colorN","color.n"],["colorNice","color.nice"],["colorScheme","color.scheme"],["colorInterpolate","color.interpolate"],["colorPivot","color.pivot"],["colorSymmetric","color.symmetric"],["colorLabel","color.label"],["colorReverse","color.reverse"],["colorZero","color.zero"],["colorTickFormat","color.tickFormat"],["colorBase","color.base"],["colorExponent","color.exponent"],["colorConstant","color.constant"],["opacityScale","opacity.type"],["opacityDomain","opacity.domain"],["opacityRange","opacity.range"],["opacityClamp","opacity.clamp"],["opacityNice","opacity.nice"],["opacityLabel","opacity.label"],["opacityReverse","opacity.reverse"],["opacityZero","opacity.zero"],["opacityTickFormat","opacity.tickFormat"],["opacityBase","opacity.base"],["opacityExponent","opacity.exponent"],["opacityConstant","opacity.constant"],["rScale","r.type"],["rDomain","r.domain"],["rRange","r.range"],["rClamp","r.clamp"],["rNice","r.nice"],["rZero","r.zero"],["rBase","r.base"],["rExponent","r.exponent"],["rConstant","r.constant"],["lengthScale","length.type"],["lengthDomain","length.domain"],["lengthRange","length.range"],["lengthClamp","length.clamp"],["lengthNice","length.nice"],["lengthZero","length.zero"],["lengthBase","length.base"],["lengthExponent","length.exponent"],["lengthConstant","length.constant"],["projectionType","projection.type"],["projectionParallels","projection.parallels"],["projectionPrecision","projection.precision"],["projectionRotate","projection.rotate"],["projectionDomain","projection.domain"],["projectionInset","projection.inset"],["projectionInsetLeft","projection.insetLeft"],["projectionInsetRight","projection.insetRight"],["projectionInsetTop","projection.insetTop"],["projectionInsetBottom","projection.insetBottom"],["projectionClip","projection.clip"]]);function ft(t,e,n){for(let i=0;i<e.length;++i){const s=e[i];i===e.length-1?t[s]=n:t=t[s]||(t[s]={})}}const yt=new Set(["frame","hexgrid","sphere","graticule"]);async function gt(t){const e={marks:[]},n=[],{attributes:i,marks:s}=t;!function(t,e,n){for(const i in t){const s=dt.get(i);if(null==s)throw new Error(`Unrecognized plot attribute: ${i}`);const r=t[i];"symbol"==typeof r?n.push(i):void 0!==r&&ft(e,s.split("."),r)}}(i,e,n);const r=[];for(const t of s)for(const{type:n,data:i,options:s}of t.plotSpecs())yt.has(n)?e.marks.push(p[n](s)):e.marks.push(p[n](i,s)),r.push(t.index);!function(t,e){const{marks:n}=e;mt("x",t,n),mt("y",t,n),mt("fx",t,n),mt("fy",t,n)}(e,t);const o=p.plot(e);!function(t,e){const n=t.querySelectorAll('g[aria-label="facet"]');if(n.length)for(const t of n)xt(t,e);else xt(t,e)}(o,r),function(t,e,n,i){i.forEach((i=>{const s=n[i];if(s!==ht)throw new Error(`Unrecognized symbol: ${s}`);{if(!i.endsWith("Domain"))throw new Error(`Unsupported fixed attribute: ${i}`);const s=i.slice(0,-6),r=e.scale(s);r?.domain&&t.setAttribute(i,n[`${s}Reverse`]?r.domain.slice().reverse():r.domain)}}))}(t,o,i,n);for(const e of t.interactors)await e.init(o);return o}function mt(t,e,n){const i=e[t]||{};if(null===i.axis||void 0!==i.label)return;const s=n.map((e=>e.channelField(t)?.field));if(s.every((t=>null==t)))return;let r,o,a;for(let e=0;e<s.length;++e){const{column:i,label:l}=s[e]||{};void 0===i&&void 0===l||(void 0===r&&void 0===o?(r=i,o=l,a=bt(n[e].data,t)||"number"):o!==l?o=void 0:r!==i&&(r=void 0))}let l=o||r;if(void 0!==l){if(!("number"!==a&&"date"!==a||"x"!==t&&"y"!==t)){i.percent&&(l=`${l} (%)`);const e=("x"===t?1:-1)*(i.reverse?-1:1);l="x"===t||"center"===i.labelAnchor?"x"===t==e<0?`← ${l}`:`${l} →`:`${e<0?"↑ ":"↓ "}${l}`}e[t]={...i,label:l}}}function xt(t,e){let n=-1;for(const i of t.children){const t=i.getAttribute("aria-label")||"";"style"===i.nodeName||t.includes("-axis")||t.includes("-grid")||i.setAttribute("data-index",e[++n])}}function bt(t,e){for(const n of t){const t=n[e]??n[e+"1"]??n[e+"2"];if(null!=t)return t instanceof Date?"date":typeof t}}const Et={width:640,marginLeft:40,marginRight:20,marginTop:20,marginBottom:30};class vt{constructor(e){this.attributes={...Et},this.listeners=null,this.interactors=[],this.legends=[],this.marks=[],this.markset=null,this.element=e||document.createElement("div"),this.element.setAttribute("class","plot"),this.element.style.display="flex",this.element.value=this,this.params=new Map,this.synch=t()}margins(){return{left:this.getAttribute("marginLeft"),top:this.getAttribute("marginTop"),bottom:this.getAttribute("marginBottom"),right:this.getAttribute("marginRight")}}innerWidth(){const{left:t,right:e}=this.margins();return this.getAttribute("width")-t-e}innerHeight(t=400){const{top:e,bottom:n}=this.margins();let i=this.getAttribute("height");return null==i&&null!=t&&(i=t,this.setAttribute("height",i,{silent:!0})),i-e-n}pending(t){this.synch.pending(t)}update(t){return this.synch.ready(t)&&!this.pendingRender&&(this.pendingRender=!0,requestAnimationFrame((()=>this.render()))),this.synch.promise}async render(){this.pendingRender=!1;const t=await gt(this),e=this.legends.flatMap((({legend:e,include:n})=>{const i=e.init(t);return n?i:[]}));this.element.replaceChildren(t,...e),this.synch.resolve()}getAttribute(t){return this.attributes[t]}setAttribute(t,n,i){return!!e(this.attributes[t],n)&&(void 0===n?delete this.attributes[t]:this.attributes[t]=n,i?.silent||this.listeners?.get(t)?.forEach((e=>e(t,n))),!0)}addAttributeListener(t,e){const n=this.listeners||(this.listeners=new Map);return n.has(t)||n.set(t,new Set),n.get(t).add(e),this}removeAttributeListener(t,e){return this.listeners?.get(t)?.delete(e)}addParams(t,e){const{params:n}=this;for(const i of e)n.has(i)?n.get(i).push(t):(n.set(i,[t]),i.addEventListener("value",(()=>Promise.allSettled(n.get(i).map((t=>t.requestQuery()))))))}addMark(t){return t.setPlot(this,this.marks.length),this.marks.push(t),this.markset=null,this}get markSet(){return this.markset||(this.markset=new Set(this.marks))}addInteractor(t){return this.interactors.push(t),this}addLegend(t,e=!0){t.setPlot(this),this.legends.push({legend:t,include:e})}}function At(t){return"string"==typeof t&&("none"===(t=t.toLowerCase().trim())||"currentcolor"===t||t.startsWith("url(")&&t.endsWith(")")||t.startsWith("var(")&&t.endsWith(")")||null!==H(t))}const Rt=new Set(["order","sort","label","anchor","curve","tension","marker","markerStart","markerMid","markerEnd","textAnchor","lineAnchor","lineHeight","textOverflow","monospace","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","frameAnchor","strokeLinejoin","strokeLinecap","strokeMiterlimit","strokeDasharray","strokeDashoffset","mixBlendMode","shapeRendering","imageRendering","preserveAspectRatio","interpolate","crossOrigin","paintOrder","pointerEvents","target"]);const wt=new Set(["asterisk","circle","cross","diamond","diamond2","hexagon","plus","square","square2","star","times","triangle","triangle2","wye"]);function Ot(t){return n(t)?function(t){const{batches:e,numRows:n}=t;if(!n)return[];const s=Array.from({length:n},(()=>({})));for(let t=0,n=0;n<e.length;++n){const r=e[n],{schema:o,numRows:a,numCols:l}=r;for(let e=0;e<l;++e){const n=r.getChildAt(e),{name:l,type:c}=o.fields[e],h=i(c);for(let e=t,i=0;i<a;++i,++e)s[e][l]=h(n.get(i))}t+=a}return s}(t):t}const Lt=t=>"stroke"===t||"fill"===t,kt=(t,e)=>({channel:t,field:e,as:e instanceof m?e.column:t}),St=(t,e)=>({channel:t,value:e}),Mt=t=>Array.isArray(t);class Tt extends s{constructor(t,e,n,i={}){super(e?.options?.filterBy),this.type=t,this.reqs=i,this.source=e,Mt(this.source)&&(this.data=this.source);const s=this.channels=[],r=this.detail=new Set,o=this.params=new Set,a=(t,e)=>{const n=typeof e;if("channels"===t)for(const t in e)r.add(t),a(t,e[t]);else if("function"===n&&e[pt]){const n=e(this,t);for(const t in n)a(t,n[t])}else if("string"===n)i=t,Rt.has(i)||Lt(t)&&At(e)||(t=>"symbol"===t)(t)&&function(t){return wt.has(`${t}`.toLowerCase())}(e)?s.push(St(t,e)):s.push(kt(t,y(e)));else if(g(e))if(Array.isArray(e.columns))s.push(kt(t,e)),o.add(e);else{const n=St(t,e.value);s.push(n),e.addEventListener("value",(t=>(n.value=t,this.update())))}else"object"===n&&((t,e)=>"sort"!==t&&"tip"!==t&&null!=e&&!Array.isArray(e))(t,e)?s.push(kt(t,e)):void 0!==e&&s.push(St(t,e));var i};for(const t in n)a(t,n[t])}setPlot(t,e){this.plot=t,this.index=e,t.addParams(this,this.params),this.source?.table&&this.queryPending()}hasOwnData(){return null==this.source||Mt(this.source)}hasFieldInfo(){return!!this._fieldInfo}channel(t){return this.channels.find((e=>e.channel===t))}channelField(t,{exact:e}={}){const n=e?this.channel(t):this.channels.find((e=>e.channel.startsWith(t)));return n?.field?n:null}fields(){if(this.hasOwnData())return null;const{source:{table:t},channels:e,reqs:n}=this,i=new Map;for(const{channel:t,field:s}of e){if(!s)continue;const e=s.stats?.stats||[],r=s.stats?.column??s,o=i.get(r)??i.set(r,new Set).get(r);e.forEach((t=>o.add(t))),n[t]?.forEach((t=>o.add(t)))}return Array.from(i,(([e,n])=>({table:t,column:e,stats:n})))}fieldInfo(t){const e=Object.fromEntries(t.map((t=>[t.column,t])));for(const t of this.channels){const{field:n}=t;n&&Object.assign(t,e[n.stats?.column??n])}return this._fieldInfo=!0,this}query(t=[]){if(this.hasOwnData())return null;const{channels:e,source:{table:n}}=this;return Nt(e,n).where(t)}queryPending(){return this.plot.pending(this),this}queryResult(t){return this.data=Ot(t),this}update(){return this.plot.update(this)}plotSpecs(){const{type:t,data:e,detail:n,channels:i}=this,s={},r={};for(const t of i){(n.has(t.channel)?r:s)[t.channel]=Ft(t)}return n.size&&(s.channels=r),[{type:t,data:e,options:s}]}}function Ft(t){return Object.hasOwn(t,"value")?t.value:Lt(t.channel)?{value:t.as,scale:"color"}:t.as}function Nt(t,e,n=[]){const i=f.from({source:e}),s=new Set;let r=!1;for(const e of t){const{channel:t,field:o,as:a}=e;if(!n.includes(t))if("orderby"===t)i.orderby(e.value);else if(o){if(o.aggregate)r=!0;else{if(s.has(a))continue;s.add(a)}i.select({[a]:o})}}return r&&i.groupby(Array.from(s)),i}function $t(t,e){const{plot:n}=t;let i=n.getAttribute(`${e}Scale`);if(!i){const{type:n}=t.channelField(e);i="date"===n?"time":"linear"}const s={type:i};switch(i){case"log":s.base=n.getAttribute(`${e}Base`)??10;break;case"pow":s.exponent=n.getAttribute(`${e}Exponent`)??1;break;case"symlog":s.constant=n.getAttribute(`${e}Constant`)??1}return x(s)}function It(t,e,n,i,s=1,r){const{field:o}=t.channelField(e);r=r??o;const{type:a,apply:l,sqlApply:c}=$t(t,e),h=!!t.plot.getAttribute(`${e}Reverse`),[u,p]=i.map((t=>l(t))),d=c(r),f=p===u?0:(n-s)/(p-u),y=1!==f?` * ${f}::DOUBLE`:"";return[h?b`(${p} - ${d}::DOUBLE)${y}`:b`(${d}::DOUBLE - ${u})${y}`,"time"===a||"utc"===a?d:r]}const Dt={x:["min","max"]},zt={y:["min","max"]},Gt={...Dt,...zt};function Ct(t,e,n,i,s){const{plot:r}=t,o=r.getAttribute(i),a=r.getAttribute(s);if(Array.isArray(o)&&!o[ut])return o;{const{column:s,min:l,max:c}=t.channelField(n),h=Pt(e,s)||(a?Y().domain([l,c]).nice().domain():[l,c]);return o!==ht&&(h[ut]=!0),r.setAttribute(i,h,{silent:!0}),h}}function qt(t,e){return Ct(t,e,"x","xDomain","xNice")}function Bt(t,e){return Ct(t,e,"y","yDomain","yNice")}function Pt(t,e){if(!t)return;let n,i;const s=(t,s)=>{if("BETWEEN"===t&&`${s.field}`===e){const{range:t}=s;t&&(null==n||t[0]<n)&&(n=t[0]),t&&(null==i||t[1]>i)&&(i=t[1])}};return Array.isArray(t)?t.forEach((t=>t.visit?.(s))):t.visit&&t.visit(s),null!=n&&null!=i&&n!==i?[n,i]:void 0}class jt extends Tt{constructor(t,e,n){const i=t.endsWith("X")?"y":t.endsWith("Y")?"x":null;super(t,e,n,i?{[i]:["min","max"]}:void 0),this.dim=i}query(t=[]){const{plot:e,dim:n,source:i}=this,{optimize:s=!0}=i.options||{},r=super.query(t);if(!n)return r;const o="x"===n?"y":"x",a=this.channelField(o,{exact:!0})?.as,{field:l,as:c,type:h,min:u,max:p}=this.channelField(n);if(s&&("date"===h||"number"===h)&&a){const i="x"===n?e.innerWidth():e.innerHeight(),[s,o]=Pt(t,l)||[u,p],[h]=It(this,n,i,[s,o],1,c),d=r.select().map((t=>t.as)).filter((t=>t!==c&&t!==a));return _t(r,h,c,a,d)}return r.orderby(l)}}function _t(t,e,n,i,s=[]){const r=b`FLOOR(${e})::INTEGER`,o=e=>f.from(t).select(e).groupby(r,s);return f.union(o([{[n]:E(n),[i]:v(i,n)},...s]),o([{[n]:A(n),[i]:R(i,n)},...s]),o([{[n]:v(n,i),[i]:E(i)},...s]),o([{[n]:R(n,i),[i]:A(i)},...s])).orderby(s,n)}function Wt(t,e="density"){return n(t)?o(t.getChild(e).type):"number"==typeof t[0]?.[e]?Float64Array:Array}function Ut(t,e){let n=0,i=0;return t.forEach((t=>{const s=t[e],r=s.length;for(let t=0;t<r;++t){const e=s[t];e<n&&(n=e),e>i&&(i=e)}})),0===n&&0===i?[0,1]:[n,i]}function Ht(t,e,n,i){a(n)?(i=i||(()=>t.requestUpdate()),n.addEventListener("value",(n=>(t[e]=n,i()))),t[e]=n.value):t[e]=n}function Yt(t,e=!1){const n=new Float64Array(5),i=new Float64Array(4);!function(t,e,n){const i=4,s=Float64Array.of(.84,1.8675,.84,-1.8675,-.34015,-.1299,-.34015,.1299),r=Math.exp(-1.783/n),o=Math.exp(-1.723/n),a=.6318/n,l=1.997/n,c=Float64Array.of(-r*Math.cos(a),r*Math.sin(a),-r*Math.cos(-a),r*Math.sin(-a),-o*Math.cos(l),o*Math.sin(l),-o*Math.cos(-l),o*Math.sin(-l)),h=2.5066282746310007*n,u=Float64Array.of(s[0],s[1],0,0,0,0,0,0),p=Float64Array.of(1,0,c[0],c[1],0,0,0,0,0,0);let d,f;for(f=2;f<8;f+=2){for(u[f]=c[f]*u[f-2]-c[f+1]*u[f-1],u[f+1]=c[f]*u[f-1]+c[f+1]*u[f-2],d=f-2;d>0;d-=2)u[d]+=c[f]*u[d-2]-c[f+1]*u[d-1],u[d+1]+=c[f]*u[d-1]+c[f+1]*u[d-2];for(d=0;d<=f;d+=2)u[d]+=s[f]*p[d]-s[f+1]*p[d+1],u[d+1]+=s[f]*p[d+1]+s[f+1]*p[d];for(p[f+2]=c[f]*p[f]-c[f+1]*p[f+1],p[f+3]=c[f]*p[f+1]+c[f+1]*p[f],d=f;d>0;d-=2)p[d]+=c[f]*p[d-2]-c[f+1]*p[d-1],p[d+1]+=c[f]*p[d-1]+c[f+1]*p[d-2]}for(f=0;f<i;++f)d=f<<1,e[f]=u[d]/h,t[f+1]=p[d+2]}(n,i,t);const s=Float64Array.of(0,i[1]-n[1]*i[0],i[2]-n[2]*i[0],i[3]-n[3]*i[0],-n[4]*i[0]),r=1+n[1]+n[2]+n[3]+n[4];return{sigma:t,negative:e,a:n,b_causal:i,b_anticausal:s,sum_causal:(i[0]+i[1]+i[2]+i[3])/r,sum_anticausal:(s[1]+s[2]+s[3]+s[4])/r}}function Vt(t,e,n,i=1,s=new Float64Array(n),r=new Float64Array(n),o=new Float64Array(5),a=s,l=Xt){const c=2*i,h=3*i,u=4*i,p=i*n;let d,f;for(l(s,e,n,i,t.b_causal,3,t.a,4,t.sum_causal,o,t.sigma),f=4,d=u;f<n;++f,d+=i)s[f]=t.b_causal[0]*e[d]+t.b_causal[1]*e[d-i]+t.b_causal[2]*e[d-c]+t.b_causal[3]*e[d-h]-t.a[1]*s[f-1]-t.a[2]*s[f-2]-t.a[3]*s[f-3]-t.a[4]*s[f-4];for(l(r,e,n,-i,t.b_anticausal,4,t.a,4,t.sum_anticausal,o,t.sigma),f=4,d=p-5*i;f<n;++f,d-=i)r[f]=t.b_anticausal[1]*e[d+i]+t.b_anticausal[2]*e[d+c]+t.b_anticausal[3]*e[d+h]+t.b_anticausal[4]*e[d+u]-t.a[1]*r[f-1]-t.a[2]*r[f-2]-t.a[3]*r[f-3]-t.a[4]*r[f-4];if(t.negative)for(f=0,d=0;f<n;++f,d+=i)a[d]=s[f]+r[n-f-1];else for(f=0,d=0;f<n;++f,d+=i)a[d]=Math.max(0,s[f]+r[n-f-1]);return a}function Xt(t,e,n,i,s,r,o,a,l,c,h,u=.5){const p=Math.abs(i)*n,d=i<0?p+i:0;let f,y,g;for(y=0;y<=a;++y)for(c[y]=y<=r?s[y]:0,g=1;g<=a&&g<=y;++g)c[y]-=o[g]*c[y-g];for(g=0;g<a;++g)for(t[g]=0,y=1;y<=g;++y)f=d+i*y,f>=0&&f<p&&(t[g]+=c[g-y]*e[f]);const m=e[d],x=Math.ceil(10*h);for(y=0;y<x;++y){for(g=0;g<a;++g)t[g]+=c[g]*m;if((l-=Math.abs(c[0]))<=u)break;for(c[a]=y+a<=r?s[y+a]:0,g=1;g<=a;++g)c[a]-=o[g]*c[a-g];for(g=0;g<a;++g)c[g]=c[g+1]}}function Zt({random:t=Q(42)}={}){return(e,n,i,s,r,o,a)=>{const{points:l,triangles:c,hull:h}=Z.from(e,(t=>s[t]),(t=>r[t])),u=new Uint8Array(n*i),p=function(t,e){return function(t){for(const e of t)if(null!=e)return"number"==typeof e}(t)||function(t){for(const e of t)if(null!=e)return e instanceof Date}(t)?te:function(t){return(e,n,i,s,r,o,a,l)=>{const c=t(a,l);return c<n?e:c<n+s?i:r}}(e)}(o,t);for(let t=0;t<c.length;t+=3){const s=c[t],r=c[t+1],h=c[t+2],d=l[2*s],f=l[2*r],y=l[2*h],g=l[2*s+1],m=l[2*r+1],x=l[2*h+1],b=Math.min(d,f,y),E=Math.max(d,f,y),v=Math.min(g,m,x),A=Math.max(g,m,x),R=(m-x)*(d-y)+(g-x)*(y-f);if(!R)continue;const w=o[e[s]],O=o[e[r]],L=o[e[h]];for(let t=Math.floor(b);t<E;++t)for(let e=Math.floor(v);e<A;++e){if(t<0||t>=n||e<0||e>=i)continue;const s=t+.5,r=e+.5,o=((m-x)*(s-y)+(r-x)*(y-f))/R;if(o<0)continue;const l=((x-g)*(s-y)+(r-x)*(d-y))/R;if(l<0)continue;const c=1-o-l;if(c<0)continue;const h=t+n*e;a[h]=p(w,o,O,l,L,c,t,e),u[h]=1}}return function(t,e,n,i,s,r,o,a,l,c){n=Float64Array.from(a,(t=>n[l[t]])),i=Float64Array.from(a,(t=>i[l[t]])),s=Array.from(a,(t=>s[l[t]]));const h=n.length,u=Array.from({length:h},((t,e)=>function(t,e,n){const i=e.length,s=e.at(t-2),r=n.at(t-2),o=e.at(t-1),a=n.at(t-1),l=e[t],c=n[t],h=e.at(t+1-i),u=n.at(t+1-i),p=o-l,d=a-c,f=s-o,y=r-a,g=l-h,m=c-u,x=Math.hypot(p,d),b=Math.hypot(f,y),E=Math.hypot(g,m);return(t,e)=>{const n=t-o,i=e-a,s=t-l,r=e-c;return Jt(n,i,s,r)>-1e-6&&Jt(n,i,p,d)*b-Jt(n,i,f,y)*x>-1e-6&&Jt(s,r,g,m)*x-Jt(s,r,p,d)*E<=0}}(e,n,i)));let p=0;for(let a=0;a<o;++a){const o=a+.5;for(let l=0;l<r;++l){const d=l+r*a;if(!e[d]){const e=l+.5;for(let r=0;r<h;++r){const f=(h+p+(r%2?(r+1)/2:-r/2))%h;if(u[f](e,o)){const r=Qt(n.at(f-1),i.at(f-1),n[f],i[f],e,o);t[d]=c(s.at(f-1),r,s[f],1-r,s[f],0,l,a),p=f;break}}}}}}(a,u,s,r,o,n,i,h,e,p),a}}function Qt(t,e,n,i,s,r){const o=n-t,a=i-e,l=o*(n-s)+a*(i-r),c=o*(s-t)+a*(r-e);return l>0&&c>0?l/(l+c):+(l>c)}function Jt(t,e,n,i){return t*i-n*e}function Kt(t,e,n,i,s,r,o){const a=Z.from(t,(t=>i[t]),(t=>s[t]));let l,c;for(let i=.5,s=0;i<n;++i){c=l;for(let n=.5;n<e;++n,++s)c=a.find(n,i,c),.5===n&&(l=c),o[s]=r[t[c]]}return o}function te(t,e,n,i,s,r){return e*t+i*n+r*s}const ee="density";class ne extends Tt{constructor(t,e,n){const{bandwidth:i=0,interpolate:s="none",pixelSize:r=1,pad:o=1,width:a,height:l,...c}=n,h=function(t){const e={};for(const n in t)"density"===t[n]&&(delete t[n],e[n]=!0);return e}(c);super(t,e,c,Gt),this.densityMap=h,Ht(this,"bandwidth",i,(()=>this.grids?this.convolve().update():null)),Ht(this,"pixelSize",r),Ht(this,"interpolate",s),Ht(this,"pad",o),Ht(this,"width",a),Ht(this,"height",l)}setPlot(t,e){const n=()=>{this.hasFieldInfo()&&this.requestUpdate()};return t.addAttributeListener("domainX",n),t.addAttributeListener("domainY",n),super.setPlot(t,e)}get filterIndexable(){const t=this.plot.getAttribute("xDomain"),e=this.plot.getAttribute("yDomain");return t&&e&&!t[ut]&&!e[ut]}query(t=[]){const{interpolate:e,pad:n,channels:i,densityMap:s,source:r}=this,[o,a]=this.extentX=qt(this,t),[l,c]=this.extentY=Bt(this,t),[h,u]=this.bins=this.binDimensions(this),[p,d]=It(this,"x",h,[o,a],n),[y,g]=It(this,"y",u,[l,c],n),m=n?[w(d,[+o,+a]),w(g,[+l,+c])]:[O(+o,d),L(d,+a),O(+l,g),L(g,+c)],x=f.from(r.table).where(t.concat(m)),E=this.groupby=[],v={};for(const t of i)if(Object.hasOwn(t,"field")){const{as:e,channel:n,field:i}=t;i.aggregate?(v[n]=i,s[n]=!0):"weight"===n?v[ee]=k(i):"x"!==n&&"y"!==n&&(x.select({[e]:i}),E.push(e))}const A=this.aggr=Object.keys(v);if(v.density&&A.length>1)throw new Error("Weight option can not be used with custom aggregates.");if(A.length||(A.push(ee),v.density=S()),"linear"===e){if(A.length>1)throw new Error("Linear binning not applicable to multiple aggregates.");if(!v.density)throw new Error("Linear binning not applicable to custom aggregates.");return function(t,e,n,i,s,r){const o=i?.column?`* ${i.column}`:"",a=(i,s)=>t.clone().select({xp:e,yp:n,i:i,w:s}),l=a(b`FLOOR(xp)::INTEGER + FLOOR(yp)::INTEGER * ${s}`,b`(FLOOR(xp)::INTEGER + 1 - xp) * (FLOOR(yp)::INTEGER + 1 - yp)${o}`),c=a(b`FLOOR(xp)::INTEGER + (FLOOR(yp)::INTEGER + 1) * ${s}`,b`(FLOOR(xp)::INTEGER + 1 - xp) * (yp - FLOOR(yp)::INTEGER)${o}`),h=a(b`FLOOR(xp)::INTEGER + 1 + FLOOR(yp)::INTEGER * ${s}`,b`(xp - FLOOR(xp)::INTEGER) * (FLOOR(yp)::INTEGER + 1 - yp)${o}`),u=a(b`FLOOR(xp)::INTEGER + 1 + (FLOOR(yp)::INTEGER + 1) * ${s}`,b`(xp - FLOOR(xp)::INTEGER) * (yp - FLOOR(yp)::INTEGER)${o}`);return f.from(f.unionAll(l,c,h,u)).select({index:"i",density:k("w")},r).groupby("index",r).having(M("density",0))}(x,p,y,v[ee],h,E)}return function(t,e,n,i,s,r){return t.select({index:b`FLOOR(${e})::INTEGER + FLOOR(${n})::INTEGER * ${s}`,...i}).groupby("index",r)}(x,p,y,v,h,E)}binDimensions(){const{plot:t,pixelSize:e,width:n,height:i}=this;return[n??Math.round(t.innerWidth()/e),i??Math.round(t.innerHeight()/e)]}queryResult(t){const[e,n]=this.bins,i=function(t="none"){if("function"==typeof t)return t;switch(`${t}`.toLowerCase()){case"none":case"linear":return;case"nearest":return Kt;case"barycentric":return Zt();case"random-walk":return function({random:t=Q(42),minDistance:e=.5,maxSteps:n=2}={}){return(i,s,r,o,a,l,c)=>{const h=Z.from(i,(t=>o[t]),(t=>a[t]));let u,p,d;for(let f=.5,y=0;f<r;++f){p=u;for(let r=.5;r<s;++r,++y){let s,g=r,m=f;d=p=h.find(g,m,p),.5===r&&(u=p);let x=0;for(;(s=Math.hypot(o[i[d]]-g,a[i[d]]-m))>e&&x<n;){const e=2*t(r,f,x)*Math.PI;g+=Math.cos(e)*s,m+=Math.sin(e)*s,d=h.find(g,m,d),++x}c[y]=l[i[d]]}}return c}}()}throw new Error(`invalid interpolate: ${t}`)}(this.interpolate);return this.grids=function(t,e,n,i,s=[],o){const a=t*e,l=i.map((t=>Wt(n,t))),c=i.length,h=t=>{const e={};return s.forEach(((n,i)=>e[n]=t[i])),i.forEach(((t,n)=>e[t]=new l[n](a))),e},u={},p=s.length?null:u[[]]=h([]),d=s.length?t=>u[t]??(u[t]=h(t)):()=>p,f=n.numRows;if(0===f)return Object.values(u);const y=r(n.getChild("index")),g=i.map((t=>r(n.getChild(t)))),m=s.map((t=>n.getChild(t)));if(o){const n=y.map((e=>e%t)),r=y.map((e=>Math.floor(e/t)));if(s.length)for(let t=0;t<f;++t){const e=d(m.map((e=>e.get(t))));e.index||(e.index=[]),e.index.push(t)}else p.index=y.map(((t,e)=>e));Object.values(u).forEach((s=>{for(let a=0;a<c;++a)o(s.index,t,e,n,r,g[a],s[i[a]]);delete s.index}))}else for(let t=0;t<f;++t){const e=d(m.map((e=>e.get(t))));for(let n=0;n<c;++n)e[i[n]][y[t]]=g[n][t]}return Object.values(u)}(e,n,t,this.aggr,this.groupby,i),this.convolve()}convolve(){const{aggr:t,bandwidth:e,bins:n,grids:i,plot:s}=this;if(this.kde=this.grids,e>0){const r=1===t.length?t[0]:t.includes(ee)?ee:null;if(!r)return console.warn("No compatible grid found for smoothing."),this;const o=s.innerWidth(),a=s.innerHeight(),[l,c]=n,h=i.some((t=>t[r].some((t=>t<0)))),u=Yt(e*(l-1)/o,h),p=Yt(e*(c-1)/a,h);this.kde=this.grids.map((t=>{const e=function(t,e,n,[i,s]){const r=new Float64Array(Math.max(i,s)),o=new Float64Array(Math.max(i,s)),a=new Float64Array(5),l=new Float64Array(n.length);for(let e=0,c=0;e<s;++e,c+=i){const e=l.subarray(c);Vt(t,n.subarray(c),i,1,r,o,a,e)}for(let t=0;t<i;++t){const n=l.subarray(t);Vt(e,n,s,i,r,o,a,n)}return l}(u,p,t[r],n);return{...t,[r]:e}}))}return this}plotSpecs(){throw new Error("Unimplemented. Use a Grid2D mark subclass.")}}class ie extends ne{constructor(t,e){const{thresholds:n=10,...i}=e;super("geo",t,{bandwidth:20,interpolate:"linear",pixelSize:2,...i}),Ht(this,"thresholds",n,(()=>this.grids?this.contours().update():null))}convolve(){return super.convolve().contours()}contours(){const{bins:t,densityMap:e,kde:n,thresholds:i,plot:s}=this;let r=i;if(!Array.isArray(r)){const[,t]=Ut(n,"density");r=Array.from({length:r-1},((e,n)=>t*(n+1)/r))}(e.fill||e.stroke)&&"log"!==this.plot.getAttribute("colorScale")&&this.plot.setAttribute("colorZero",!0);const[o,a]=t,[l,c]=s.getAttribute("xDomain"),[h,u]=s.getAttribute("yDomain"),p=(c-l)/o,d=(u-h)/a,f=+l,y=+h,g=t=>f+t*p,m=t=>y+t*d,x=J().size(t);return this.data=n.flatMap((t=>r.map((e=>Object.assign(function(t,e,n){function i(t){t.forEach(s)}function s(t){t.forEach(r)}function r(t){t[0]=e(t[0]),t[1]=n(t[1])}return t.coordinates.forEach(i),t}(x.contour(t.density,e),g,m),{...t,density:e}))))),this}plotSpecs(){const{type:t,channels:e,densityMap:n,data:i}=this,s={};for(const t of e){const{channel:e}=t;"x"!==e&&"y"!==e&&(s[e]=Ft(t))}return n.fill&&(s.fill="density"),n.stroke&&(s.stroke="density"),[{type:t,data:i,options:s}]}}function se(t,e){if("undefined"!=typeof document){const n=document.createElement("canvas");return n.setAttribute("width",t),n.setAttribute("height",e),n}throw new Error("Can not create a canvas instance.")}class re extends ne{constructor(t,e){super("image",t,e)}setPlot(t,e){t.addAttributeListener("schemeColor",(()=>{this.hasFieldInfo()&&this.rasterize()})),super.setPlot(t,e)}convolve(){return super.convolve().rasterize()}rasterize(){const{bins:t,kde:e}=this,[n,i]=t,{canvas:s,ctx:r,img:o}=function(t,e,n){if(!t.image||t.image.w!==e||t.image.h!==n){const i=se(e,n),s=i.getContext("2d",{willReadFrequently:!0}),r=s.getImageData(0,0,e,n);t.image={canvas:i,ctx:s,img:r,w:e,h:n}}return t.image}(this,n,i),{alpha:a,alphaProp:l,color:c,colorProp:h}=ae(this);return this.data=e.map((t=>(c?.(o.data,n,i,t[h]),a?.(o.data,n,i,t[l]),r.putImageData(o,0,0),{src:s.toDataURL()}))),this}plotSpecs(){const{type:t,plot:e,data:n}=this;return[{type:t,data:n,options:{src:"src",width:e.innerWidth(),height:e.innerHeight(),preserveAspectRatio:"none",imageRendering:this.channel("imageRendering")?.value,frameAnchor:"middle"}}]}}class oe extends re{constructor(t,e){super(t,{bandwidth:20,interpolate:"linear",pixelSize:2,...e})}}function ae(t){const{aggr:e,densityMap:n,groupby:i,plot:s}=t,r=e.includes(ee),o=e.includes("fillOpacity"),a=t.channel("fill"),l=t.channel("fillOpacity");if(e.length>2||r&&o)throw new Error("Invalid raster encodings. Try dropping an aggregate?");if(i.includes(l?.as))throw new Error("Raster fillOpacity must be an aggregate or constant.");const c=n.fill||e.includes("fill")?"grid":i.includes(a?.as)?"group":At(a?.value)?a.value:r&&s.getAttribute("colorScheme")?"grid":void 0,h=n.fillOpacity||e.includes("fillOpacity")?"grid":"number"==typeof l?.value?l.value:r&&"grid"!==c?"grid":void 0;if("grid"!==c&&"grid"!==h)throw new Error("Raster mark missing density values.");const u=a?.as??("grid"===c?ee:null),p=l?.as??("grid"===h?ee:null),f="grid"!==c&&"group"!==c?function(t={}){const{r:e=0,g:n=0,b:i=0,opacity:s=1}="string"==typeof t?K(t):t,r=new Uint8ClampedArray([e,n,i,255*s|0]);return(t,e,n)=>{for(let i=0,s=0;i<n;++i)for(let n=0;n<e;++n,s+=4)t[s+0]=r[0],t[s+1]=r[1],t[s+2]=r[2],t[s+3]=r[3]}}(c):function(t,e){const{plot:n,kde:i}=t,s=!i[0][e]?.map,r=s||Array.isArray(i[0][e]),o=n.getAttribute("colorDomain"),a=o===ht,l=o?.[ut],c=!a&&!l&&o||(s?i.map((t=>t[e])).sort(X):r?function(t,e){const n=new V;return t.forEach((t=>{const i=t[e],s=i.length;for(let t=0;t<s;++t)n.add(i[t])})),Array.from(n).sort(X)}(i,e):Ut(i,e));(a||l)&&(l&&(c[ut]=!0),n.setAttribute("colorDomain",c));const h=d({color:{type:n.getAttribute("colorScale"),domain:c,range:n.getAttribute("colorRange"),clamp:n.getAttribute("colorClamp"),n:n.getAttribute("colorN"),nice:n.getAttribute("colorNice"),reverse:n.getAttribute("colorReverse"),scheme:n.getAttribute("colorScheme"),interpolate:n.getAttribute("colorInterpolate"),pivot:n.getAttribute("colorPivot"),symmetric:n.getAttribute("colorSymmetric"),zero:n.getAttribute("colorZero"),base:n.getAttribute("colorBase"),exponent:n.getAttribute("colorExponent"),constant:n.getAttribute("colorConstant")}});if(r)return function(t){const{domain:e,range:n}=t,i=Object.create(null),s=new Uint8ClampedArray(4*e.length),r=e.length-1,o=n.length;for(let t=0;t<=r;++t){const r=n[t%o],{r:a,g:l,b:c,opacity:h=1}="string"==typeof r?K(r):r,u=t<<2;s[u+0]=a,s[u+1]=l,s[u+2]=c,s[u+3]=255*h|0,i[e[t]]=u}return(t,e,n,r)=>{if(r.map)for(let o=0,a=0;o<n;++o)for(let l=0,c=(n-o-1)*e;l<e;++l,a+=4){const e=i[r[l+c]];t[a+0]=s[e+0],t[a+1]=s[e+1],t[a+2]=s[e+2],t[a+3]=s[e+3]}else{const o=i[r];for(let i=0,r=0;i<n;++i)for(let n=0;n<e;++n,r+=4)t[r+0]=s[o+0],t[r+1]=s[o+1],t[r+2]=s[o+2],t[r+3]=s[o+3]}}}(h);return function(t,e,n){const{interpolate:i}=e,s=new Uint8ClampedArray(4*t),r=t-1;for(let t=0;t<=r;++t){const e=i(t/r),{r:n,g:o,b:a,opacity:l=1}="string"==typeof e?K(e):e,c=t<<2;s[c+0]=n,s[c+1]=o,s[c+2]=a,s[c+3]=255*l|0}return(t,e,i,o)=>{for(let a=0,l=0;a<i;++a)for(let c=0,h=(i-a-1)*e;c<e;++c,l+=4){const e=r*n(o[c+h])<<2;t[l+0]=s[e+0],t[l+1]=s[e+1],t[l+2]=s[e+2],t[l+3]=s[e+3]}}}(1024,h,d({x:{type:le(h.type),domain:h.domain,reverse:h.reverse,range:[0,1],clamp:h.clamp,base:h.base,exponent:h.exponent,constant:h.constant}}).apply)}(t,u),y="grid"!==h?function(t=1){const e=255*t|0;return(t,n,i)=>{for(let s=0,r=0;s<i;++s)for(let i=0;i<n;++i,r+=4)t[r+3]=e}}(h):function(t,e){const{plot:n,kde:i}=t,s=n.getAttribute("opacityDomain"),r=s===ht,o=s?.[ut],a=!r&&!o&&s||Ut(i,e);(r||o)&&(o&&(a[ut]=!0),n.setAttribute("colorDomain",a));const l=d({opacity:{type:n.getAttribute("opacityScale"),domain:a,clamp:n.getAttribute("opacityClamp"),nice:n.getAttribute("opacityNice"),reverse:n.getAttribute("opacityReverse"),zero:n.getAttribute("opacityZero"),base:n.getAttribute("opacityBase"),exponent:n.getAttribute("opacityExponent"),constant:n.getAttribute("opacityConstant")}});return function(t){const{apply:e}=t;return(t,n,i,s)=>{for(let r=0,o=0;r<i;++r)for(let a=0,l=(i-r-1)*n;a<n;++a,o+=4)t[o+3]=255*e(s[a+l])|0}}(l)}(t,p);return{alphaProp:p,colorProp:u,alpha:y,color:f}}function le(t){return t.endsWith("symlog")?"symlog":t.endsWith("log")?"log":t.endsWith("pow")?"pow":t.endsWith("sqrt")?"sqrt":"diverging"===t?"linear":t}class ce extends re{constructor(t,e){const{normalize:n=!0,...i}=e;super(t,i),Ht(this,"normalize",n)}query(t=[]){const{channels:e,normalize:n,source:i,binPad:s}=this,[r,o]=this.bins=this.binDimensions(this),[a]=It(this,"x",r,qt(this,t),s),[l]=It(this,"y",o,Bt(this,t),s),c=f.from(i.table).where(function(t,e){if(Array.isArray(e)&&!e.length)return e;const{column:n}=t.channelField("x"),{column:i}=t.channelField("y"),s=t=>{const e=`${t.field}`;return"BETWEEN"!==t.op||e!==n&&e!==i},r=t=>"AND"===t.op?T(t.children.filter((t=>s(t)))):t;return Array.isArray(e)?e.filter((t=>s(t))).map((t=>r(t))):r(e)}(this,t));this.aggr=["density"];const h=this.groupby=[],u=[];for(const t of e)if(Object.hasOwn(t,"field")){const{channel:e,field:n}=t;"z"===e?(c.select({[e]:n}),u.push("z")):"x"!==e&&"y"!==e&&(c.select({[e]:n}),h.push(e))}return function(t,e,n,i,s,r,o=[],a=!0){t.select({x:b`FLOOR(${e})::INTEGER`,y:b`FLOOR(${n})::INTEGER`});const l=o.concat(i),c=l.length?`PARTITION BY ${l.join(", ")} `:"",h=f.from(t).select(l,{x0:"x",y0:"y",dx:b`(lead(x) OVER sw - x)`,dy:b`(lead(y) OVER sw - y)`}).window({sw:b`${c}ORDER BY x ASC`}).qualify(T(b`(x0 < ${s} OR x0 + dx < ${s})`,b`(y0 < ${r} OR y0 + dy < ${r})`,b`(x0 > 0 OR x0 + dx > 0)`,b`(y0 > 0 OR y0 + dy > 0)`)),u=f.select({x:b`GREATEST(MAX(ABS(dx)), MAX(ABS(dy)))`}).from("pairs"),p=f.select({i:b`UNNEST(range((${u})))::INTEGER`}),d=f.unionAll(f.select(l,{x:b`x0 + i`,y:b`y0 + ROUND(i * dy / dx::FLOAT)::INTEGER`}).from("pairs","indices").where(b`ABS(dy) <= ABS(dx) AND i < ABS(dx)`),f.select(l,{x:b`x0 + ROUND(SIGN(dy) * i * dx / dy::FLOAT)::INTEGER`,y:b`y0 + SIGN(dy) * i`}).from("pairs","indices").where(b`ABS(dy) > ABS(dx) AND i < ABS(dy)`),f.select(l,{x:"x0",y:"y0"}).from("pairs").where(F("dx"))),y=["x"].concat(l).join(", "),g=f.from("raster").select(l,"x","y",a?{w:b`1.0 / COUNT(*) OVER (PARTITION BY ${y})`}:null).where(T(w("x",[0,s],!0),w("y",[0,r],!0)));return f.with({pairs:h,indices:p,raster:d,points:g}).from("points").select(o,{index:b`x + y * ${s}::INTEGER`,density:a?k("w"):S()}).groupby("index",o)}(c,a,l,u,r,o,h,n)}}class he extends Tt{constructor(t,e,n){const{bins:i=1024,bandwidth:s=20,...r}=n,o=t.endsWith("X")?"y":"x";super(t,e,r,"x"===o?Dt:zt),this.dim=o,Ht(this,"bins",i),Ht(this,"bandwidth",s,(()=>this.grid?this.convolve().update():null))}get filterIndexable(){const t="x"===this.dim?"xDomain":"yDomain",e=this.plot.getAttribute(t);return e&&!e[ut]}query(t=[]){if(this.hasOwnData())throw new Error("Density1DMark requires a data source");const{bins:e,channels:n,dim:i,source:{table:s}}=this,r=this.extent=("x"===i?qt:Bt)(this,t),[o,a]=It(this,i,e,r);return function(t,e,n){const i=n?`* ${n}`:"",s=t.clone().select({p:e,i:b`FLOOR(p)::INTEGER`,w:b`(FLOOR(p) + 1 - p)${i}`}),r=t.clone().select({p:e,i:b`FLOOR(p)::INTEGER + 1`,w:b`(p - FLOOR(p))${i}`});return f.from(f.unionAll(s,r)).select({index:"i",density:k("w")}).groupby("index").having(N("density",0))}(Nt(n,s,[i]).where(t.concat(w(a,r))),o,this.channelField("weight")?"weight":null)}queryResult(t){return this.grid=function(t,e,i="density"){const s=new(Wt(e))(t);if(n(e)){const t=e.numRows;if(0===t)return s;const n=r(e.getChild("index")),o=r(e.getChild(i));for(let e=0;e<t;++e)s[n[e]]=o[e]}else for(const t of e)s[t.index]=t[i];return s}(this.bins,t),this.convolve()}convolve(){const{bins:t,bandwidth:e,dim:n,grid:i,plot:s,extent:[r,o]}=this,a=i.some((t=>t<0)),l=Vt(Yt(e*(t-1)/("x"===n?s.innerWidth():s.innerHeight()),a),i,t),c=this.data=[],h="x"===n?"y":"x",u=this.channelField(n).as,p=+r,d=(o-p)/(t-1),f=1/d;for(let e=0;e<t;++e)c.push({[u]:p+e*d,[h]:l[e]*f});return this}plotSpecs(){const{type:t,data:e,channels:n,dim:i}=this,s="x"===i?{y:"y"}:{x:"x"};for(const t of n)s[t.channel]=Ft(t);return[{type:t,data:e,options:s}]}}class ue extends ne{constructor(t,e){const{type:n="dot",...i}=e;super(n,t,{bandwidth:20,interpolate:"linear",pad:0,pixelSize:2,...i})}convolve(){super.convolve();const{bins:t,pad:e,extentX:n,extentY:i}=this,[s,r]=t,o=$t(this,"x"),a=$t(this,"y"),[l,c]=n.map((t=>o.apply(t))),[h,u]=i.map((t=>a.apply(t))),p=(c-l)/(s-e),d=(u-h)/(r-e),f=e?0:.5;return this.data=function(t,e,n,i,s,r,o,a,l){const c=1/(s*r),[h,u]=e,p=[];for(const e of t){const t=e.density;for(let d=0,f=0;f<u;++f)for(let u=0;u<h;++u,++d)p.push({...e,x:o(n+(u+l)*s),y:a(i+(f+l)*r),density:t[d]*c})}return p}(this.kde,t,l,h,p,d,o.invert,a.invert,f),this}plotSpecs(){const{type:t,channels:e,densityMap:n,data:i}=this,s={};for(const t of e){const{channel:e}=t;s[e]="x"===e||"y"===e?e:Ft(t)}for(const t in n)n[t]&&(s[t]="density");return[{type:t,data:i,options:s}]}}class pe extends Tt{constructor(t,e={},n){Mt(t)||e?.geometry||(e.geometry=$("geom")),super("geo",t,e,n)}queryResult(t){super.queryResult(t);const e=this.channelField("geometry")?.as;return e&&this.data&&this.data.forEach((t=>{"string"==typeof t[e]&&(t[e]=JSON.parse(t[e]))})),this}}class de extends Tt{constructor(t,e){const{type:n="hexagon",binWidth:i=20,...s}=e;super(n,t,{r:i/2,clip:!0,...s},Gt),this.binWidth=i}get filterIndexable(){const t=this.plot.getAttribute("xDomain"),e=this.plot.getAttribute("yDomain");return t&&e&&!t[ut]&&!e[ut]}query(t=[]){if(this.hasOwnData())return null;const{plot:e,binWidth:n,channels:i,source:s}=this,[r,o]=qt(this,t),[a,l]=Bt(this,t),c=.5-e.getAttribute("marginLeft"),h=0-e.getAttribute("marginTop"),u=`${n}::DOUBLE`,p=n*(1.5/Math.sqrt(3))+"::DOUBLE",d=e.innerWidth()/(o-r)+"::DOUBLE",y=e.innerHeight()/(l-a)+"::DOUBLE";let g,m;const x=new Set,E={};for(const t of i)"orderby"===t.channel?v.orderby(t.value):"x"===t.channel?g=t:"y"===t.channel?m=t:Object.hasOwn(t,"field")&&(E[t.as]=t.field,t.field.aggregate&&t.field.columns.forEach((t=>x.add(t))));const v=f.select({[g.as]:b`${r}::DOUBLE + ((x + 0.5 * (y & 1)) * ${u} + ${c})::DOUBLE / ${d}`,[m.as]:b`${l}::DOUBLE - (y * ${p} + ${h})::DOUBLE / ${y}`,...E}).groupby("x","y"),A=`${d} * (${g.field} - ${r}::DOUBLE)`,R=`${y} * (${l}::DOUBLE - ${m.field})`,w=f.select({py:b`(${R} - ${h}) / ${p}`,pj:b`ROUND(py)::INTEGER`,px:b`(${A} - ${c}) / ${u} - 0.5 * (pj & 1)`,pi:b`ROUND(px)::INTEGER`,tt:b`ABS(py-pj) * 3 > 1 AND (px-pi)**2 + (py-pj)**2 > (px - pi - 0.5 * CASE WHEN px < pi THEN -1 ELSE 1 END)**2 + (py - pj - CASE WHEN py < pj THEN -1 ELSE 1 END)**2`,x:b`CASE WHEN tt THEN (pi + (CASE WHEN px < pi THEN -0.5 ELSE 0.5 END) + (CASE WHEN pj & 1 <> 0 THEN 0.5 ELSE -0.5 END))::INTEGER ELSE pi END`,y:b`CASE WHEN tt THEN (pj + CASE WHEN py < pj THEN -1 ELSE 1 END)::INTEGER ELSE pj END`}).select(Array.from(x)).from(s.table).where(I(g.field),I(m.field),t);return v.from(w)}}class fe extends ne{constructor(t,e){const{origin:n=[0,0],dim:i="xy",...s}=e;super("image",t,s),this.origin=n,this.tileX=i.toLowerCase().includes("x"),this.tileY=i.toLowerCase().includes("y")}setPlot(t,e){t.addAttributeListener("schemeColor",(()=>{this.hasFieldInfo()&&this.rasterize()})),super.setPlot(t,e)}requestQuery(){return this.requestTiles()}query(t=[]){return this._filter=t,null}tileQuery(t){const{binType:e,binPad:n,channels:i,densityMap:s,source:r}=this,[[o,a],[l,c]]=t,[h,u]=this.bins,[p,d]=It(this,"x",h,[o,a],n),[y,g]=It(this,"y",u,[l,c],n),m=n?[w(d,[+o,+a]),w(g,[+l,+c])]:[O(+o,d),L(d,+a),O(+l,g),L(g,+c)],x=f.from(r.table).where(m),E=this.groupby=[],v={};for(const t of i)if(Object.hasOwn(t,"field")){const{as:e,channel:n,field:i}=t;i.aggregate?(v[n]=i,s[n]=!0):"weight"===n?v.density=k(i):"x"!==n&&"y"!==n&&(x.select({[e]:i}),E.push(e))}const A=this.aggr=Object.keys(v);if(v.density&&A.length>1)throw new Error("Weight option can not be used with custom aggregates.");if(A.length||(A.push("density"),v.density=S()),"linear"===e){if(A.length>1)throw new Error("Linear binning not applicable to multiple aggregates.");if(!v.density)throw new Error("Linear binning not applicable to custom aggregates.");return function(t,e,n,i,s,r){const o=i.column?`* ${i.column}`:"",a=(i,s)=>t.clone().select({xp:e,yp:n,i:i,w:s}),l=a(b`FLOOR(xp)::INTEGER + FLOOR(yp)::INTEGER * ${s}`,b`(FLOOR(xp)::INTEGER + 1 - xp) * (FLOOR(yp)::INTEGER + 1 - yp)${o}`),c=a(b`FLOOR(xp)::INTEGER + (FLOOR(yp)::INTEGER + 1) * ${s}`,b`(FLOOR(xp)::INTEGER + 1 - xp) * (yp - FLOOR(yp)::INTEGER)${o}`),h=a(b`FLOOR(xp)::INTEGER + 1 + FLOOR(yp)::INTEGER * ${s}`,b`(xp - FLOOR(xp)::INTEGER) * (FLOOR(yp)::INTEGER + 1 - yp)${o}`),u=a(b`FLOOR(xp)::INTEGER + 1 + (FLOOR(yp)::INTEGER + 1) * ${s}`,b`(xp - FLOOR(xp)::INTEGER) * (yp - FLOOR(yp)::INTEGER)${o}`);return f.from(f.unionAll(l,c,h,u)).select({index:"i",density:k("w")},r).groupby("index",r).having(M("density",0))}(x,p,y,v.density,h,E)}return function(t,e,n,i,s,r){return t.select({index:b`FLOOR(${e})::INTEGER + FLOOR(${n})::INTEGER * ${s}`,...i}).groupby("index",r)}(x,p,y,v,h,E)}async requestTiles(){const t=l();this.prefetch&&t.cancel(this.prefetch);const{binPad:e,tileX:n,tileY:i,origin:[s,r]}=this,[o,a]=this.bins=this.binDimensions(this),[c,h]=qt(this,this._filter),[u,p]=Bt(this,this._filter),d=h-c,f=p-u,y=Math.floor((c-s)*(o-e)/d),g=Math.floor((u-r)*(a-e)/f),m=(t,e)=>[[s+t*d,s+(t+1)*d],[r+e*f,r+(e+1)*f]],x=Math.floor((c-s)/d),b=n?ge((h-s)/d):x,E=Math.floor((u-r)/f),v=i?ge((p-r)/f):E,A=[];for(let t=x;t<=b;++t)for(let e=E;e<=v;++e)A.push([t,e]);const R=A.map((([e,n])=>t.query(this.tileQuery(m(e,n))))),w=[];if(n)for(let t=E;t<=v;++t)w.push([b+1,t]),w.push([x-1,t]);if(i){const t=n?b+1:b;for(let e=n?x-1:x;e<=t;++e)w.push([e,v+1]),w.push([e,E-1])}this.prefetch=w.map((([e,n])=>t.prefetch(this.tileQuery(m(e,n)))));const O=await Promise.all(R);this.grids=[{density:ye(o,a,y,g,A,O)}],this.convolve().update()}convolve(){return super.convolve().rasterize()}rasterize(){const{bins:t,kde:e}=this,[n,i]=t,{canvas:s,ctx:r,img:o}=function(t,e,n){if(!t.image||t.image.w!==e||t.image.h!==n){const i=se(e,n),s=i.getContext("2d",{willReadFrequently:!0}),r=s.getImageData(0,0,e,n);t.image={canvas:i,ctx:s,img:r,w:e,h:n}}return t.image}(this,n,i),{alpha:a,alphaProp:l,color:c,colorProp:h}=ae(this);return this.data=e.map((t=>(c?.(o.data,n,i,t[h]),a?.(o.data,n,i,t[l]),r.putImageData(o,0,0),{src:s.toDataURL()}))),this}plotSpecs(){const{type:t,data:e,plot:n}=this;return[{type:t,data:e,options:{src:"src",width:n.innerWidth(),height:n.innerHeight(),preserveAspectRatio:"none",imageRendering:this.channel("imageRendering")?.value,frameAnchor:"middle"}}]}}function ye(t,e,n,i,s,r){const o=new Float64Array(t*e);return r.forEach(((r,a)=>{const[l,c]=s[a];!function(t,e,n,i,s,r){const o=i.numRows;if(0===o)return;const a=i.getChild("index").toArray(),l=i.getChild("density").toArray();for(let i=0;i<o;++i){const o=a[i],c=s+o%t,h=r+Math.floor(o/t);0<=c&&c<t&&0<=h&&h<e&&(n[c+h*t]=l[i])}}(t,e,o,r,l*t-n,c*e-i)})),o}function ge(t){const e=Math.floor(t);return e===t?e-1:e}function me(t,e,n){var i=0===t||1===t?0:Math.exp(be(e+n)-be(e)-be(n)+e*Math.log(t)+n*Math.log(1-t));return!(t<0||t>1)&&(t<(e+1)/(e+n+2)?i*xe(t,e,n)/e:1-i*xe(1-t,n,e)/n)}function xe(t,e,n){var i,s,r,o,a=1e-30,l=1,c=e+n,h=e+1,u=e-1,p=1,d=1-c*t/h;for(Math.abs(d)<a&&(d=a),o=d=1/d;l<=100&&(d=1+(s=l*(n-l)*t/((u+(i=2*l))*(e+i)))*d,Math.abs(d)<a&&(d=a),p=1+s/p,Math.abs(p)<a&&(p=a),o*=(d=1/d)*p,d=1+(s=-(e+l)*(c+l)*t/((e+i)*(h+i)))*d,Math.abs(d)<a&&(d=a),p=1+s/p,Math.abs(p)<a&&(p=a),o*=r=(d=1/d)*p,!(Math.abs(r-1)<3e-7));l++);return o}function be(t){var e,n,i,s=0,r=[76.18009172947146,-86.5053203294167,24.01409824083091,-1.231739572450155,.001208650973866179,-5395239384953e-18],o=1.000000000190015;for(i=(n=e=t)+5.5,i-=(e+.5)*Math.log(i);s<6;s++)o+=r[s]/++n;return Math.log(2.506628274631*o/e)-i}function Ee(t,e){var n=function(t,e,n){var i,s,r,o,a,l,c,h,u,p,d=e-1,f=n-1,y=0;if(t<=0)return 0;if(t>=1)return 1;for(e>=1&&n>=1?(r=t<.5?t:1-t,l=(2.30753+.27061*(o=Math.sqrt(-2*Math.log(r))))/(1+o*(.99229+.04481*o))-o,t<.5&&(l=-l),c=(l*l-3)/6,h=2/(1/(2*e-1)+1/(2*n-1)),u=l*Math.sqrt(c+h)/h-(1/(2*n-1)-1/(2*e-1))*(c+5/6-2/(3*h)),l=e/(e+n*Math.exp(2*u))):(i=Math.log(e/(e+n)),s=Math.log(n/(e+n)),l=t<(o=Math.exp(e*i)/e)/(u=o+(a=Math.exp(n*s)/n))?Math.pow(e*u*t,1/e):1-Math.pow(n*u*(1-t),1/n)),p=-be(e)-be(n)+be(e+n);y<10;y++){if(0===l||1===l)return l;if((l-=o=(a=(me(l,e,n)-t)/(o=Math.exp(d*Math.log(l)+f*Math.log(1-l)+p)))/(1-.5*Math.min(1,a*(d/l-f/(1-l)))))<=0&&(l=.5*(l+o)),l>=1&&(l=.5*(l+o+1)),Math.abs(o)<1e-8*l&&y>0)break}return l}(2*Math.min(t,1-t),.5*e,.5);return n=Math.sqrt(e*(1-n)/n),t>.5?n:-n}class ve extends Tt{constructor(t,e){const{ci:n=.95,precision:i=4,...s}=e;super("line",t,s);const r=()=>this.modelFit?this.confidenceBand().update():null;Ht(this,"ci",n,r),Ht(this,"precision",i,r)}query(t=[]){const e=this.channelField("x").as,n=this.channelField("y").as,i=Array.from(new Set(["stroke","z","fx","fy"].flatMap((t=>this.channelField(t)?.as||[]))));return f.from(super.query(t)).select({intercept:D(n,e),slope:z(n,e),n:G(n,e),ssy:C(n,e),ssx:q(n,e),xm:B(n,e),x0:P(E(e).where(I(n))),x1:P(A(e).where(I(n)))}).select(i).groupby(i)}queryResult(t){return this.modelFit=Ot(t),this.lineData=this.modelFit.flatMap((t=>function(t){const{x0:e,x1:n,xm:i,intercept:s,slope:r,n:o,ssx:a,ssy:l,...c}=t;return[{x:e,y:s+e*r,...c},{x:n,y:s+n*r,...c}]}(t))),this.confidenceBand()}confidenceBand(){const{ci:t,modelFit:e,precision:n,plot:i}=this,s=i.innerWidth();return this.areaData=t?e.flatMap((e=>function(t,e,n,i){const{x0:s,x1:r,xm:o,intercept:a,slope:l,n:c,ssx:h,ssy:u,...p}=n,d=e*(r-s)/i,f=Ee((1-t)/2,c-2)*Math.sqrt(u/(c-2));return tt(s,r-d/2,d).concat(r).map((t=>{const e=a+t*l,n=f*Math.sqrt(1/c+(t-o)**2/h);return{x:t,y1:e-n,y2:e+n,...p}}))}(t,n,e,s))):null,this}plotSpecs(){const{lineData:t,areaData:e,channels:n,ci:i}=this,s={x:"x",y:"y"},r={x:"x",y1:"y1",y2:"y2",fillOpacity:.1};for(const t of n)switch(t.channel){case"x":case"y":case"fill":break;case"stroke":s.stroke=r.fill=Ft(t);break;case"strokeOpacity":s.strokeOpacity=Ft(t);break;case"fillOpacity":r.fillOpacity=Ft(t);break;default:s[t.channel]=r[t.channel]=Ft(t)}return[...i?[{type:"areaY",data:e,options:r}]:[],{type:"line",data:t,options:s}]}}function Ae(t){const e=t.toLowerCase(),n=t.length;let i="";for(let s=0;s<n;++s)i+=(t[s]!==e[s]?"-":"")+e[s];return i}function Re(t){const e={};for(const n in t)e[Ae(n)]=t[n];return e}class we{constructor(t,{selection:e,channels:n={}}){this.mark=function(t){const{channels:e}=t,n=new Set;let i=!1,s=!1;for(const t of e){const{channel:e,field:r,as:o}=t;if("orderby"===e)i=!0;else if(r)if(r.aggregate)s=!0;else{if(n.has(o))continue;n.add(o)}}return!i&&s&&n.size&&t.channels.push({channel:"orderby",value:Array.from(n)}),t}(t),this.selection=e;const i=Object.entries(Re(n));this.channels=i.length?i:[["opacity",.2]],this.selection.addEventListener("value",c((()=>this.update())))}init(t){this.svg=t;const e=this.values=[],n=this.mark.index,i=this.nodes=t.querySelectorAll(`[data-index="${n}"] > *`),{channels:s}=this;for(let t=0;t<i.length;++t){const n=i[t];e.push(s.map((t=>n.getAttribute(t[0]))))}return this.update()}async update(){const{svg:t,nodes:e,channels:n,values:i,mark:s,selection:r}=this;if(!t)return;const o=await async function(t,e){const n=e?.predicate(t);if(!n||0===n.length)return()=>!0;const i=t.filterBy?.predicate(t,!0),s={__:T(n)},r=t.query(i),o=r.groupby().length?r.select(s):r.$select(s),a=await t.coordinator.query(o),l=a.getChild?.("__");return a.numRows||a.length?l?t=>l.get(t):t=>a[t].__:()=>!1}(s,r);for(let t=0;t<e.length;++t){const s=e[t],r=i[t],a=o(s.__data__);for(let t=0;t<n.length;++t){const[e,i]=n[t];s.setAttribute(e,a?r[t]:i)}}}}function Oe(t){const e=t.on;let n=!0;function i(t){n=!1,t(),n=!0}return t.reset=(...e)=>{i((()=>t.clear(...e)))},t.moveSilent=(...e)=>{i((()=>t.move(...e)))},t.on=(...t)=>{if(t.length>1&&t[1]){const e=t[1];t[1]=(...t)=>n&&e(...t)}return e(...t)},t}function Le(t,e){return t===e||t&&e&&Math.abs(t[0]-e[0])<1e-12&&Math.abs(t[1]-e[1])<1e-12||!1}function ke(t,e){const n=t.channelField(e)?.field;return n?.basis||n}function Se(t,e,n=1){return e.invert(n*Math.floor(t/n))}function Me(){const t=this,e=t.getScreenCTM;let n;t.getScreenCTM=()=>t.isConnected?n=e.call(t):n}class Te{constructor(t,{channel:e,selection:n,field:i,pixelSize:s=1,peers:r=!0,brush:o}){this.mark=t,this.channel=e,this.pixelSize=s||1,this.selection=n,this.peers=r,this.field=i||ke(t,e),this.style=o&&Re(o),this.brush=Oe("y"===e?it():nt()),this.brush.on("brush end",(({selection:t})=>this.publish(t)))}reset(){this.value=void 0,this.g&&this.brush.reset(this.g)}activate(){this.selection.activate(this.clause(this.value||[0,1]))}publish(t){let e;t&&(e=t.map((t=>Se(t,this.scale,this.pixelSize))).sort(((t,e)=>t-e))),Le(e,this.value)||(this.value=e,this.g.call(this.brush.moveSilent,t),this.selection.update(this.clause(e)))}clause(t){const{mark:e,pixelSize:n,field:i,scale:s}=this;return{source:this,schema:{type:"interval",pixelSize:n,scales:[s]},clients:this.peers?e.plot.markSet:(new Set).add(e),value:t,predicate:t?w(i,t):null}}init(t){const{brush:e,channel:n,style:i}=this;this.scale=t.scale(n);const s=t.scale("x").range,r=t.scale("y").range;e.extent([[st(s),st(r)],[rt(s),rt(r)]]);const o=ot(t).selectAll('g[aria-label="facet"]'),a=o.size()?o:ot(t);if(this.g=a.append("g").attr("class",`interval-${n}`).each(Me).call(e).call(e.moveSilent,this.value?.map(this.scale.apply)),i){const t=this.g.selectAll("rect.selection");for(const e in i)t.attr(e,i[e])}t.addEventListener("pointerenter",(()=>this.activate()))}}const Fe=(t,e)=>t-e;class Ne{constructor(t,{selection:e,xfield:n,yfield:i,pixelSize:s=1,peers:r=!0,brush:o}){this.mark=t,this.pixelSize=s||1,this.selection=e,this.peers=r,this.xfield=n||ke(t,"x"),this.yfield=i||ke(t,"y"),this.style=o&&Re(o),this.brush=Oe(et()),this.brush.on("brush end",(({selection:t})=>this.publish(t)))}reset(){this.value=void 0,this.g&&this.brush.reset(this.g)}activate(){this.selection.activate(this.clause(this.value||[[0,1],[0,1]]))}publish(t){const{value:e,pixelSize:n,xscale:i,yscale:s}=this;let r,o;if(t){const[e,a]=t;r=[e[0],a[0]].map((t=>Se(t,i,n))).sort(Fe),o=[e[1],a[1]].map((t=>Se(t,s,n))).sort(Fe)}Le(r,e?.[0])&&Le(o,e?.[1])||(this.value=t?[r,o]:void 0,this.g.call(this.brush.moveSilent,t),this.selection.update(this.clause(this.value)))}clause(t){const{mark:e,pixelSize:n,xfield:i,yfield:s,xscale:r,yscale:o}=this;return{source:this,schema:{type:"interval",pixelSize:n,scales:[r,o]},clients:this.peers?e.plot.markSet:(new Set).add(e),value:t,predicate:t?T(w(i,t[0]),w(s,t[1])):null}}init(t){const{brush:e,style:n}=this,i=this.xscale=t.scale("x"),s=this.yscale=t.scale("y"),r=i.range,o=s.range;e.extent([[st(r),st(o)],[rt(r),rt(o)]]);const a=ot(t).selectAll('g[aria-label="facet"]'),l=a.size()?a:ot(t);if(this.g=l.append("g").attr("class","interval-xy").each(Me).call(e),n){const t=this.g.selectAll("rect.selection");for(const e in n)t.attr(e,n[e])}if(this.value){const[t,n]=this.value[0].map(i.apply).sort(Fe),[r,o]=this.value[1].map(s.apply).sort(Fe);this.g.call(e.moveSilent,[[t,r],[n,o]])}t.addEventListener("pointerenter",(()=>this.activate()))}}class $e{constructor(t,{selection:e,channel:n,field:i}){this.mark=t,this.selection=e,this.clients=(new Set).add(t),this.channel=n,this.field=i||ke(t,[n])}clause(t){const{clients:e,field:n}=this;return{source:this,schema:{type:"point"},clients:e,value:t,predicate:t?j(n,_(t)):null}}init(t){const e=this,{mark:n,channel:i,selection:s}=this,{data:r}=n,o=n.channelField(i).as,a=ot(t).selectAll('g[aria-label="facet"]'),l=a.size()?a:ot(t),c=t.scale(i),u=!h(s);l.on("pointerdown pointermove",(function(t){const[n,a]=at(t,this),l=function(t,e,n){let i,s=1/0;return t.forEach((t=>{const r=Math.abs(t[e]-n);r<s&&(s=r,i=t[e])})),i}(r,o,c.invert("x"===i?n:a));s.update(u?l:e.clause(l))})),u||t.addEventListener("pointerenter",(()=>{this.selection.activate(this.clause(0))}))}}const Ie=(t,e)=>t-e;class De{constructor(t,{x:e=new u,y:n=new u,xfield:i,yfield:s,zoom:r=!0,panx:o=!0,pany:a=!0}){this.mark=t,this.xsel=e,this.ysel=n,this.xfield=i||ke(t,"x"),this.yfield=s||ke(t,"y"),this.zoom=ze(r,[0,1/0],[1,1]),this.panx=this.xsel&&o,this.pany=this.ysel&&a;const{plot:l}=t;o&&this.xsel.addEventListener("value",(t=>{l.setAttribute("xDomain",t)&&l.update()})),a&&this.ysel.addEventListener("value",(t=>{l.setAttribute("yDomain",t)&&l.update()}))}publish(t){if(this.panx){const e=function(t,e){return e.range.map(t.invertX,t).map(e.invert,e)}(t,this.xscale);this.xsel.update(this.clause(e,this.xfield,this.xscale))}if(this.pany){const e=function(t,e){return e.range.map(t.invertY,t).map(e.invert,e)}(t,this.yscale);this.ysel.update(this.clause(e,this.yfield,this.yscale))}}clause(t,e,n){return{source:this,schema:{type:"interval",scales:[n]},clients:this.mark.plot.markSet,value:t,predicate:t?w(e,t):null}}init(t){if(this.svg=t,this.initialized)return;this.initialized=!0;const{panx:e,pany:n,mark:{plot:{element:i}},xsel:s,ysel:r}=this;this.xscale=t.scale("x"),this.yscale=t.scale("y");const o=this.xscale.range.slice().sort(Ie),a=this.yscale.range.slice().sort(Ie),l=ze(e,[-1/0,1/0],o),c=ze(n,[-1/0,1/0],a),h=lt().extent([[o[0],a[0]],[o[1],a[1]]]).scaleExtent(this.zoom).translateExtent([[l[0],c[0]],[l[1],c[1]]]).on("start",(()=>{this.xscale=this.svg.scale("x"),this.yscale=this.svg.scale("y")})).on("end",(()=>i.__zoom=new ct(1,0,0))).on("zoom",(({transform:t})=>this.publish(t)));if(ot(i).call(h),e||n){let t=!1;i.addEventListener("mouseenter",(()=>{if(!t){if(t=!0,e){const{xscale:t,xfield:e}=this;s.activate(this.clause(t.domain,e,t))}if(n){const{yscale:t,yfield:e}=this;r.activate(this.clause(t.domain,e,t))}}})),i.addEventListener("mouseleave",(()=>t=!1))}}}function ze(t,e,n){return t?Array.isArray(t)?t:e:n}class Ge{constructor(t,{selection:e,channels:n,peers:i=!0}){this.value=null,this.mark=t,this.selection=e,this.peers=i,this.channels=n.map((e=>{const n="color"===e?["fill","stroke"]:"x"===e?["x","x1","x2"]:"y"===e?["y","y1","y2"]:[e];for(let e=0;e<n.length;++e){const i=t.channelField(n[e]);if(i)return{field:i.field?.basis||i.field,as:i.as}}throw new Error(`Missing channel: ${e}`)}))}clause(t){const{channels:e,mark:n}=this;let i=null;if(t){const n=t.map((t=>{const n=t.map(((t,n)=>W(e[n].field,_(t))));return n.length>1?T(n):n[0]}));i=n.length>1?U(n):n[0]}return{source:this,schema:{type:"point"},clients:this.peers?n.plot.markSet:(new Set).add(n),value:t,predicate:i}}init(t,e,n){const{mark:i,channels:s,selection:r}=this,{data:o}=i;n=n||(t=>{const e=o[t.__data__];return s.map((t=>e[t.as]))}),e=e||`[data-index="${i.index}"]`;const a=new Set(t.querySelectorAll(e));t.addEventListener("pointerdown",(t=>{const e=r.single?r.value:this.value,i=t.target;let s=null;if(function(t,e){return t.has(e)||t.has(e.parentNode)||t.has(e.parentNode?.parentNode)}(a,i)){const r=n(i);t.shiftKey&&e?.length?(s=e.filter((t=>Ce(t,r))),s.length===e.length&&s.push(r)):s=1!==e?.length||Ce(e[0],r)?[r]:null}var o,l;this.value=s,l=s,(null==(o=e)||null==l?null!=o||null!=l:o.length!==l.length||o.some(((t,e)=>Ce(t,l[e]))))&&r.update(this.clause(s))})),t.addEventListener("pointerenter",(()=>{this.selection.activate(this.clause([this.channels.map((()=>0))]))}))}}function Ce(t,e){const n=t.length;if(e.length!==n)return!0;for(let i=0;i<n;++i)if(t[i]!==e[i])return!0;return!1}class qe{constructor(t,e){const{as:n,...i}=e;this.channel=t,this.options={label:null,...i},this.selection=n,this.element=document.createElement("div"),this.element.setAttribute("class","legend"),this.element.value=this}setPlot(t){const{channel:e,selection:n}=this,i=function({marks:t},e){const n="color"===e?["fill","stroke"]:"opacity"===e?["opacity","fillOpacity","strokeOpacity"]:null;if(null==n)return null;for(let e=t.length-1;e>-1;--e)for(const i of n)if(t[e].channelField(i,{exact:!0}))return t[e];return null}(t,e);this.selection&&i&&(this.handler=new Ge(i,{selection:n,channels:[e]}),this.selection.addEventListener("value",(()=>this.update())))}init(t){const{channel:e,options:n,handler:i}=this,s="ordinal"===t.scale(e).type?n:{marginTop:1,tickSize:2,height:28,...n};return this.legend=t.legend(e,s),i&&(i.init(this.legend,":scope > div",(t=>[t.__data__])),this.update()),this.element.replaceChildren(this.legend),this.element}update(){if(!this.legend)return;const{value:t}=this.selection,e=t&&t.length?new Set(t.map((t=>t[0]))):null,n=this.legend.querySelectorAll(":scope > div");for(const t of n){const n=!e||e.has(t.__data__);t.style.opacity=n?1:.2}}}const Be=new Set(["rectY-x","rectX-y","rect-x","rect-y"]);function Pe(t,e={steps:25}){const n=(n,i)=>Be.has(`${n.type}-${i}`)?{[`${i}1`]:je(n,i,t,e),[`${i}2`]:je(n,i,t,{...e,offset:1})}:{[i]:je(n,i,t,e)};return n[pt]=!0,n}function je(t,e,n,i){return{column:n,label:n,get stats(){return{column:n,stats:["min","max"]}},get columns(){return[n]},get basis(){return n},toString(){const{apply:s,sqlApply:r,sqlInvert:o}=$t(t,e),{min:a,max:l}=t.channelField(e),c=function(t,e,n){let{steps:i=25,minstep:s=0,nice:r=!0}=n;if(!1!==r){const n=e-t,r=i,o=Math.LN10,a=Math.ceil(Math.log(r)/o);let l=Math.max(s,Math.pow(10,Math.round(Math.log(n)/o)-a));for(;Math.ceil(n/l)>r;)l*=10;const c=[5,2];let h;for(let t=0,e=c.length;t<e;++t)h=l/c[t],h>=s&&n/h<=r&&(l=h);h=Math.log(l);const u=h>=0?0:1+~~(-h/o),p=Math.pow(10,-u-1);h=Math.floor(t/l+p)*l,t=t<h?h-l:h,e=Math.ceil(e/l)*l,i=Math.round((e-t)/l)}return{min:t,max:e,steps:i}}(s(a),s(l),i),h=r(n),u=0===c.min?h:`(${h} - ${c.min})`,p=(c.max-c.min)/c.steps+"::DOUBLE",d=i.offset?`${i.offset} + `:"";return`${o(`${c.min} + ${p} * (${d}FLOOR(${u} / ${p}))`)}`}}}export{jt as ConnectedMark,ie as ContourMark,ce as DenseLineMark,he as Density1DMark,ue as Density2DMark,ht as Fixed,pe as GeoMark,ne as Grid2DMark,oe as HeatmapMark,de as HexbinMark,we as Highlight,Te as Interval1D,Ne as Interval2D,qe as Legend,Tt as Mark,$e as Nearest,De as PanZoom,vt as Plot,re as RasterMark,fe as RasterTileMark,ve as RegressionMark,Ge as Toggle,pt as Transform,ut as Transient,Pe as bin};export default null;
