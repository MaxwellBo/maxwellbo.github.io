<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>friendship2 ٩(◕‿◕｡)۶</title>
  <style>
    @font-face {
      font-family: 'heart font';
      src: url(fonts/heartfont.ttf) format('truetype');
    }

    body {
      padding-left: 2rem !important;
      color: rgb(93, 22, 55);
      margin: 0;
      padding: 0;
    }

    /** hide things that don't have the showiniframe class */
    .iframe > :not(.showiniframe) {
      display: none;
    }

    button {
      /* prevent double tap to zoom */
      touch-action: manipulation;
    }

    .break-all {
      word-break: break-all;
    }

    #bracelet {
      margin-top: 50px;
      height: 400px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    #tie-button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
    }

    #buttons {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h1><a href="?">friendship2 (◕‿◕)</a></h1>
  <p>make a friendship bracelet for someone please (´｡• ω •｡`) ♡</p>

  <div id="meta">
  </div>
  <svg id="bracelet" viewBox="0 0 400 400" class="showiniframe">
    <defs>
      <path id="leftPath" d="M 250,400 C 250,250 100,150 100,50" stroke="black" stroke-width="2" />
      <path id="rightPath" d="M 250,400 C 250,250 400,150 400,50" stroke="black" stroke-width="2" />
      <path id="fullPath" d="M 100,0
        A 100,100 0 1,0 100,200
        A 100,100 0 1,0 100,0" fill="none" stroke="black" transform="rotate(-90 100 100)" />
    </defs>
    <!-- <use id="useLeftPath" href="#leftPath" />
    <use id="useRightPath" href="#rightPath" /> -->
    <text fill="black" font-size="20">
      <textPath id="leftTextPath" href="#leftPath"></textPath>
      <textPath id="rightTextPath" href="#rightPath"></textPath>
      <textPath id="fullTextPath" href="#fullPath"></textPath>
    </text>
  </svg>
  <div id="embedinstructions">
  </div>


  <section id="builder">
    <div id="buttons">
      <div id="left">
        <h2>left (๑˃ᴗ˂)ﻭ</h2>
        <!-- heart emojis -->
        <button onclick="addToBracelet('left', '💛')">💛</button>
        <button onclick="addToBracelet('left', '💚')">💚</button>
        <button onclick="addToBracelet('left', '💙')">💙</button>
        <button onclick="addToBracelet('left', '💜')">💜</button>
        <button onclick="addToBracelet('left', '💖')">💖</button>
        <button onclick="addToBracelet('left', '💕')">💕</button>
        <button onclick="addToBracelet('left', '💞')">💞</button>
        <button onclick="addToBracelet('left', '💓')">💓</button>
        <button onclick="addToBracelet('left', '💗')">💗</button>
        <button onclick="addToBracelet('left', '💘')">💘</button>
        <button onclick="addToBracelet('left', '💝')">💝</button>
        <button onclick="addToBracelet('left', '💟')">💟</button>
        <button onclick="addToBracelet('left', '🔵')">🔵</button>
        <button onclick="addToBracelet('left', '🔴')">🔴</button>
        <button onclick="addToBracelet('left', '⚫')">⚫</button>
        <button onclick="addToBracelet('left', '⚪')">⚪</button>
        <button onclick="addToBracelet('left', '🔺')">🔺</button>
        <button onclick="addToBracelet('left', '🔻')">🔻</button>
        <button onclick="addToBracelet('left', '🔸')">🔸</button>
        <button onclick="addToBracelet('left', '🔹')">🔹</button>
        <button onclick="addToBracelet('left', '🔶')">🔶</button>
        <button onclick="addToBracelet('left', '🔷')">🔷</button>
        <button onclick="addToBracelet('left', '🟢')">🟢</button>
        <button onclick="addToBracelet('left', '🟠')">🟠</button>
        <button onclick="addToBracelet('left', '🟡')">🟡</button>
        <button onclick="addToBracelet('left', '🟣')">🟣</button>
        <button onclick="addToBracelet('left', '🟤')">🟤</button>
        <button onclick="addToBracelet('left', 'A')">A</button>
        <button onclick="addToBracelet('left', 'B')">B</button>
        <button onclick="addToBracelet('left', 'C')">C</button>
        <button onclick="addToBracelet('left', 'D')">D</button>
        <button onclick="addToBracelet('left', 'E')">E</button>
        <button onclick="addToBracelet('left', 'F')">F</button>
        <button onclick="addToBracelet('left', 'G')">G</button>
        <button onclick="addToBracelet('left', 'H')">H</button>
        <button onclick="addToBracelet('left', 'I')">I</button>
        <button onclick="addToBracelet('left', 'J')">J</button>
        <button onclick="addToBracelet('left', 'K')">K</button>
        <button onclick="addToBracelet('left', 'L')">L</button>
        <button onclick="addToBracelet('left', 'M')">M</button>
        <button onclick="addToBracelet('left', 'N')">N</button>
        <button onclick="addToBracelet('left', 'O')">O</button>
        <button onclick="addToBracelet('left', 'P')">P</button>
        <button onclick="addToBracelet('left', 'Q')">Q</button>
        <button onclick="addToBracelet('left', 'R')">R</button>
        <button onclick="addToBracelet('left', 'S')">S</button>
        <button onclick="addToBracelet('left', 'T')">T</button>
        <button onclick="addToBracelet('left', 'U')">U</button>
        <button onclick="addToBracelet('left', 'V')">V</button>
        <button onclick="addToBracelet('left', 'W')">W</button>
        <button onclick="addToBracelet('left', 'X')">X</button>
        <button onclick="addToBracelet('left', 'Y')">Y</button>
        <button onclick="addToBracelet('left', 'Z')">Z</button>
        <button onclick="popLeft()">remove from left</button>
      </div>
      <div id="right">
        <h2>right (≧◡≦)</h2>
        <button onclick="addToBracelet('right', '💛')">💛</button>
        <button onclick="addToBracelet('right', '💚')">💚</button>
        <button onclick="addToBracelet('right', '💙')">💙</button>
        <button onclick="addToBracelet('right', '💜')">💜</button>
        <button onclick="addToBracelet('right', '💖')">💖</button>
        <button onclick="addToBracelet('right', '💕')">💕</button>
        <button onclick="addToBracelet('right', '💞')">💞</button>
        <button onclick="addToBracelet('right', '💓')">💓</button>
        <button onclick="addToBracelet('right', '💗')">💗</button>
        <button onclick="addToBracelet('right', '💘')">💘</button>
        <button onclick="addToBracelet('right', '💝')">💝</button>
        <button onclick="addToBracelet('right', '💟')">💟</button>
        <button onclick="addToBracelet('right', '🔵')">🔵</button>
        <button onclick="addToBracelet('right', '🔴')">🔴</button>
        <button onclick="addToBracelet('right', '⚫')">⚫</button>
        <button onclick="addToBracelet('right', '⚪')">⚪</button>
        <button onclick="addToBracelet('right', '🔺')">🔺</button>
        <button onclick="addToBracelet('right', '🔻')">🔻</button>
        <button onclick="addToBracelet('right', '🔸')">🔸</button>
        <button onclick="addToBracelet('right', '🔹')">🔹</button>
        <button onclick="addToBracelet('right', '🔶')">🔶</button>
        <button onclick="addToBracelet('right', '🔷')">🔷</button>
        <button onclick="addToBracelet('right', '🟢')">🟢</button>
        <button onclick="addToBracelet('right', '🟠')">🟠</button>
        <button onclick="addToBracelet('right', '🟡')">🟡</button>
        <button onclick="addToBracelet('right', '🟣')">🟣</button>
        <button onclick="addToBracelet('right', '🟤')">🟤</button>
        <button onclick="addToBracelet('right', 'A')">A</button>
        <button onclick="addToBracelet('right', 'B')">B</button>
        <button onclick="addToBracelet('right', 'C')">C</button>
        <button onclick="addToBracelet('right', 'D')">D</button>
        <button onclick="addToBracelet('right', 'E')">E</button>
        <button onclick="addToBracelet('right', 'F')">F</button>
        <button onclick="addToBracelet('right', 'G')">G</button>
        <button onclick="addToBracelet('right', 'H')">H</button>
        <button onclick="addToBracelet('right', 'I')">I</button>
        <button onclick="addToBracelet('right', 'J')">J</button>
        <button onclick="addToBracelet('right', 'K')">K</button>
        <button onclick="addToBracelet('right', 'L')">L</button>
        <button onclick="addToBracelet('right', 'M')">M</button>
        <button onclick="addToBracelet('right', 'N')">N</button>
        <button onclick="addToBracelet('right', 'O')">O</button>
        <button onclick="addToBracelet('right', 'P')">P</button>
        <button onclick="addToBracelet('right', 'Q')">Q</button>
        <button onclick="addToBracelet('right', 'R')">R</button>
        <button onclick="addToBracelet('right', 'S')">S</button>
        <button onclick="addToBracelet('right', 'T')">T</button>
        <button onclick="addToBracelet('right', 'U')">U</button>
        <button onclick="addToBracelet('right', 'V')">V</button>
        <button onclick="addToBracelet('right', 'W')">W</button>
        <button onclick="addToBracelet('right', 'X')">X</button>
        <button onclick="addToBracelet('right', 'Y')">Y</button>
        <button onclick="addToBracelet('right', 'Z')">Z</button>
        <button onclick="popRight()">remove from right</button>
      </div>
    </div>

    <input type="text" id="creator" placeholder="your name (required)" required />
    <input type="text" id="recipient" placeholder="recipient's name (required)" required />
    <button id="tie-button" onclick="tieBracelet()">tie bracelet</button>
  </section>

  <section>
    <h2>others braclets ˖✧◝(⁰▿⁰)◜✧˖° </h2>
    newest to oldest
    <ul>
    </ul>
  </section>

  <footer>
    <a href="/">← max bo</a>
    <a href="https://github.com/MaxwellBo/maxwellbo.github.io/blob/master/friendship2.html">source</a>
  </footer>

  <script type="module">
    // tag the document with an iframe CSS class if it's being rendered in an iframe
    if (window.self !== window.top) {
      // set iframe on the body
      document.body.classList.add('iframe');
    }

    const urlParams = new URLSearchParams(window.location.search);
    const braceletId = urlParams.get('id');
    if (braceletId) {
      fetchBracelet(braceletId);
    }

    function addToBracelet(side, emoji) {
      if (side === 'left') {
        document.getElementById('leftTextPath').textContent += emoji;
      } else if (side === 'right') {
        document.getElementById('rightTextPath').textContent += emoji;
      }
    }

    function popLeft() {
      const leftTextPath = document.getElementById('leftTextPath').textContent;
      document.getElementById('leftTextPath').textContent = leftTextPath.slice(0, -1);
    }

    function popRight() {
      const rightTextPath = document.getElementById('rightTextPath').textContent;
      document.getElementById('rightTextPath').textContent = rightTextPath.slice(0, -1);
    }

    async function tieBracelet() {
      const leftText = document.getElementById('leftTextPath').textContent;
      const rightText = document.getElementById('rightTextPath').textContent;
      const creator = document.getElementById('creator').value;
      const recipient = document.getElementById('recipient').value;
      const fullText = leftText + rightText;

      if (!creator || !recipient) {
        alert('please tell me your name and the recipient\'s name (｡•́︿•̀｡)');
        return;
      }

      // explain that bracelet is being tied and to wait
      alert('tying bracelet... please wait (´･ᴗ･ ` )');

      // Send the POST request
      const response = await fetch('https://mbo-friendship2.web.val.run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          content: fullText,
          creator,
          recipient,
          plea: "please don't abuse this, i'm just trying to make something fun (｡•́︿•̀｡)"
        })
      });

      if (!response.ok) {
        alert('failed to tie bracelet. please try again (｡•́︿•̀｡)');
        return;
      }

      const responseData = await response.json();
      alert(`bracelet tied!!! ＼(≧▽≦)／ ID: ${responseData.id}`);

      // redirect to the new bracelet
      window.location.href = `friendship2.html?id=${responseData.id}`;
    }

    async function fetchBracelet(id) {
      const response = await fetch(`https://mbo-friendship2.web.val.run?id=${id}`, {
        method: 'GET'
      });

      if (!response.ok) {
        alert('failed to fetch bracelet. please check the ID and try again (｡╯︵╰｡)');
        return;
      }

      const bracelet = await response.json();
      // set the title
      document.title = bracelet.content;

      if (document.getElementById('leftTextPath')) {
        document.getElementById('leftTextPath').remove();
      }
      if (document.getElementById('rightTextPath')) {
        document.getElementById('rightTextPath').remove();
      }
      document.getElementById('fullTextPath').textContent = bracelet.content;

      const useFullPath = document.createElementNS('http://www.w3.org/2000/svg', 'use');
      useFullPath.setAttribute('href', '#fullPath');
      document.getElementById('bracelet').appendChild(useFullPath);

      // hide the builder section
      document.getElementById('builder').style.display = 'none';


      // add the creator, recipient and id to the meta section
      const meta = document.getElementById('meta');
      meta.innerHTML = `
        <i>
          creator: ${bracelet.creator}<br />
          recipient: ${bracelet.recipient}<br />
          id: ${bracelet.id}<br />
          created at: ${bracelet.createdAt}
        </i>
      `;

      // add embed instructions explaining how to iframe the bracelet
      const embedInstructions = document.getElementById('embedinstructions');
      embedInstructions.innerHTML = `
        <p>copy and paste this code into your website to embed this bracelet</p>
        <pre style="overflow-y: scroll">
  &lt;iframe src="maxbo.me/friendship2.html?id=${bracelet.id}" style="border: none;"&gt;&lt;/iframe&gt;
        </pre>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.href)}" />
      `;
    }

    async function fetchBracelets() {
      const response = await fetch('https://mbo-friendship2.web.val.run', {
        method: 'GET'
      });

      if (!response.ok) {
        alert('Failed to fetch bracelets. Please try again.');
        return;
      }

      const bracelets = await response.json();
      const ul = document.querySelector('ul');
      ul.innerHTML = '';
      // reverse the bracelets so the newest ones are at the top
      bracelets.reverse();

      for (const bracelet of bracelets) {
        const li = document.createElement('li');
        if (bracelet.id === "5212b733-6602-4074-980e-ffa83b13a75c") {
          // debug
          continue
        }

        li.innerHTML = `<a class="break-all" href="friendship2.html?id=${bracelet.id}">${bracelet.content}</a>`;
        ul.appendChild(li);
      }
    }

    fetchBracelets();

    window.popLeft = popLeft;
    window.popRight = popRight;
    window.addToBracelet = addToBracelet;
    window.tieBracelet = tieBracelet;
  </script>
</body>

</html>