<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Off-label GF2P8AFFINEQB</title>

  <style>
    @import url('./stylesheets/fonts.css');
    @import url('./stylesheets/gf2p8affineqb-visualizer.css');

    body {
      font-family: 'Happy Times at the IKOB', 'Times New Roman', serif;
      max-width: 800px;
      background-color: #cecece;
      margin: 0 auto;
      color: rgb(30, 20, 77);
      /* font-family: 'Xanh Mono', serif; */
      padding: 20px;
    }

    blockquote {
      border-left: 1px solid red;
      padding-left: 20px;
      margin-left: 0;
    }

    
    pre {
      background-color: #f4f4f4;
      padding: 10px;
      overflow-x: auto;
    }

    table {
      border-collapse: collapse;
    }

    table, th, td {
      border: 1px solid red;
    }

    td, th {
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #ddd;
    }
    
  </style>
</head>

<body>

  <main>

    <h1>Off-label GF2P8AFFINEQB</h1>

    <p>
      Often used as a way to take the piss out of CISC ISAs, <a href="https://www.felixcloutier.com/x86/gf2p8affineqb">GF2P8AFFINEQB</a>, the Galois Field Affine Transformation, part of the "Galois Field New Instructions" x86 extension, is actually quite useful.

      Unlike <a href="https://www.felixcloutier.com/x86/gf2p8affineinvqb">GF2P8AFFINEINVQB</a> and <a href="https://www.felixcloutier.com/x86/gf2p8mulb">GF2P8MULB</a>,
      which have more obvious relevance for performing the <a href="https://en.wikipedia.org/wiki/Rijndael_S-box">Rijndael S-box</a> and <a href="https://en.wikipedia.org/wiki/Rijndael_MixColumns">Rijndael MixColumns</a> steps of <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a> respectively, GF2P8AFFINEQB is a little more general-purpose, finding "off-label" usage outside of cryptography.
    </p>

    <h2>What is a Galois field?</h2>

    <p>
      Intel's 
    <a href="https://builders.intel.com/docs/networkbuilders/galois-field-new-instructions-gfni-technology-guide-1-1639042826.pdf">
      Galois Field New Instructions (GFNI) Technology Guide
    </a> gives a rather succinct definition:

    </p>
    <blockquote>
      A Galois Field is a field containing a finite number of elements. As with other fields, a Galois Field has well defined elements, and
    operations for addition, subtraction, and so on, when applied to those elements generates a result in the same field. The <math xmlns="http://www.w3.org/1998/Math/MathML"><mi>GF</mi><mo>(</mo><mn>2</mn><mo>)</mo></math> field
    is simply a Galois Field with only two elements – 0 and 1. The addition of two values in <math xmlns="http://www.w3.org/1998/Math/MathML"><mi>GF</mi><mo>(</mo><mn>2</mn><mo>)</mo></math> is equivalent to addition-modulo-2, or
    an exclusive-OR. The multiplication of two values in <math xmlns="http://www.w3.org/1998/Math/MathML"><mi>GF</mi><mo>(</mo><mn>2</mn><mo>)</mo></math> is equivalent to multiplication-modulo-2, or the logical AND operation.

      <div style="text-align: right; display: block;">
        — Wunk, <a href="https://wunkolo.github.io/post/2020/11/gf2p8affineqb-bit-reversal/"><cite>gf2p8affineqb: Bit reversal</cite></a>
      </div>
    </blockquote>


    <div style="display: flex; gap: 20px; justify-content: center;">
      <table>
      <tr>
      <th>+</th>
      <th>0</th>
      <th>1</th>
      </tr>
      <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      </tr>
      <tr>
      <th>1</th>
      <td>1</td>
      <td>0</td>
      </tr>
      </table>

      <table>
      <tr>
      <th>×</th>
      <th>0</th>
      <th>1</th>
      </tr>
      <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      </tr>
      <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      </tr>
      </table>
    </div>

    <h2>What does GF2P8AFFINEQB do?</h2>

    <p>
      The GF2P8AFFINEQB instruction performs an affine transformation in <math xmlns="http://www.w3.org/1998/Math/MathML"><mi>GF</mi><mo>(</mo><msup><mn>2</mn><mn>8</mn></msup><mo>)</mo></math>. For this instruction, an affine transformation is defined by <math xmlns="http://www.w3.org/1998/Math/MathML"><mi>A</mi><mo>⋅</mo><mi>x</mi><mo>+</mo><mi>b</mi></math> where <math xmlns="http://www.w3.org/1998/Math/MathML"><mi>A</mi></math> is an 8 by 8 bit matrix, and <math xmlns="http://www.w3.org/1998/Math/MathML"><mi>x</mi></math> and <math xmlns="http://www.w3.org/1998/Math/MathML"><mi>b</mi></math> are 8-bit vectors.
    </p>

    <h3>Identity transformation</h3>
    <div id="viz-identity" class="simulator-container"></div>

    <h3>Bit reversal</h3>
    <div id="viz-bit-reversal" class="simulator-container"></div>

    <h3>5-bit sign extension</h3>
    <div id="viz-sign-extension" class="simulator-container"></div>

    <blockquote>
      In typical matrix fashion, each of the rows of the matrix determines how the resulting bits of the new 8-bit integer is defined. The bytes are defined in reverse order though, as the definition of the function defines its byte-indexing in reverse(7 - i) order. Byte 0 defines how bit-7 is built, byte 1 defines how bit-6 is built, byte 2 defines how bit-5 is built, and so on.
    </blockquote>

    <script type="module">
      import { createVisualization, matrixToSrc2 } from './js/gf2p8affineqb-visualizer.js';

      const identityMatrix = 0x0102040810204080n;
      const identitySrc1 = new Uint8Array(16);
      identitySrc1[0] = 0b10110011;
      const identitySrc2 = matrixToSrc2(identityMatrix);
      
      createVisualization(
        document.getElementById('viz-identity'),
        identitySrc1,
        identitySrc2,
        0x00
      );

      // Bit reversal
      const reversalMatrix = 0x8040201008040201n;
      const reversalSrc1 = new Uint8Array(16);
      reversalSrc1[0] = 0b10101100;
      const reversalSrc2 = matrixToSrc2(reversalMatrix);
      
      createVisualization(
        document.getElementById('viz-bit-reversal'),
        reversalSrc1,
        reversalSrc2,
        0x00
      );

      // Sign extension
      const signExtMatrix = 0x0102040810101010n;
      const signExtSrc1 = new Uint8Array(16);
      signExtSrc1[0] = 0b00010010;
      const signExtSrc2 = matrixToSrc2(signExtMatrix);
      
      createVisualization(
        document.getElementById('viz-sign-extension'),
        signExtSrc1,
        signExtSrc2,
        0x00
      );
    </script>

    <h2>Usage in the real world</h2>

    <a href="https://gist.github.com/animetosho/d3ca95da2131b5813e16b5bb1b137ca0">
      Unexpected Uses for the Galois Field Affine Transformation Instruction
    </a>

    <br />

    <a href="https://stackoverflow.com/questions/59124720/what-are-the-avx-512-galois-field-related-instructions-for">
      What are the AVX-512 Galois-field-related instructions for?
    </a>

    <h3>Reed-Solomon error correction</h3>

    <a href="https://github.com/klauspost/reedsolomon">klauspost/reedsolomon</a>

    <h3>PS3 Cell floating point emulation</h3>

    <p>
      <a href="https://www.youtube.com/watch?v=19ae5Mq2lJE">Here's the video that discusses it</a>
    </p>

    <p>
      <a href="https://github.com/RPCS3/rpcs3/pull/8712/files">PR</a>
    </p>

    <p>
      <a href="https://github.com/RPCS3/rpcs3/pull/14669">another PR</a>
    </p>

    <p>
      <a href="https://github.com/Whatcookie/rpcs3/blob/732fd479121fe09587fb43fce0cebb55f085d5e7/rpcs3/Emu/Cell/SPURecompiler.cpp#L7284-L7340">Updated version</a>
    </p>

    <h3>Go GC</h3>

    <p>
      <a href="https://go.dev/blog/greenteagc">https://go.dev/blog/greenteagc</a>
    </p>

    <h2>What can we apply it to?</h2>

    <p>
      &lt;search for an application and get a speedup&gt;
    </p>

  https://gist.github.com/animetosho/d3ca95da2131b5813e16b5bb1b137ca0 

  https://bitmath.blogspot.com/2023/04/not-transposing-16x16-bitmatrix.html


  https://github.com/riscv/riscv-bitmanip/wiki 

  https://wunkolo.github.io/post/2020/11/gf2p8affineqb-bit-reversal/

    <a href="https://github.com/animetosho/ParPar/blob/master/fast-gf-multiplication.md#affine-transformation--bit-matrix-xor">
      i don't even fucking know man
    </a>


  </main>
</body>

</html>
